<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SignFlow - Idioms Come Alive</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ==================== VARIABLES GLOBALES ==================== */
    :root {
      --slate-950: #020617;
      --slate-900: #0f172a;
      --slate-850: #1a2340;
      --slate-800: #1e293b;
      --slate-700: #334155;
      --slate-600: #475569;
      --slate-400: #94a3b8;
      --slate-300: #cbd5e1;
      --blue-400: #60a5fa;
      --blue-500: #3b82f6;
      --blue-600: #2563eb;
      --cyan-600: #0891b2;
      --purple-600: #7e3af2;
      --purple-500: #9333ea;
      --pink-600: #db2777;
      --pink-900: #831843;
      --green-600: #16a34a;
      --green-900: #052e16;
      --red-600: #dc2626;
      --red-900: #450a0a;
      --orange-600: #ea580c;
      --orange-900: #431407;
      --yellow-400: #facc15; /* Amarillo brillante para "flow" */
      --yellow-500: #f59e0b;
      --amber-400: #fbbf24;
      --amber-500: #f59e0b;
      --emerald-500: #10b981;
      --teal-500: #14b8a6;
      --violet-600: #8b5cf6;
      --indigo-600: #4f46e5;
    }
    /* ==================== ESTILOS BASE ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--slate-950) 0%, var(--slate-900) 100%);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 10% 20%, rgba(96, 165, 250, 0.08) 0%, transparent 20%),
        radial-gradient(circle at 90% 30%, rgba(126, 58, 242, 0.08) 0%, transparent 20%),
        radial-gradient(circle at 50% 80%, rgba(219, 39, 119, 0.08) 0%, transparent 20%);
      z-index: -1;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    /* ==================== PARTICULAS DE FONDO ==================== */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
    /* ==================== SPLASH SCREEN ==================== */
    .splash-screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
      background: linear-gradient(135deg, var(--slate-950) 0%, var(--slate-900) 50%, var(--slate-950) 100%);
      overflow: hidden;
      perspective: 1000px;
    }
    .splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .splash-title {
      font-size: 7.5rem;
      font-weight: 900;
      margin-bottom: 1.5rem;
      text-align: center;
      opacity: 0;
      transform: translateY(50px) rotateX(15deg);
      transition: all 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
      letter-spacing: -1px;
      position: relative;
      display: inline-block;
    }
    .splash-title.visible {
      opacity: 1;
      transform: translateY(0) rotateX(0);
    }
    .splash-title span {
      display: inline-block;
    }
    .splash-title .sign {
      color: white;
      text-shadow: 0 0 25px rgba(255, 255, 255, 0.8),
                  0 0 50px rgba(96, 165, 250, 0.5),
                  0 0 75px rgba(96, 165, 250, 0.3);
      animation: textGlow 2.5s infinite alternate;
      position: relative;
      z-index: 2;
    }
    .splash-title .flow {
      color: var(--yellow-400); /* AMARILLO BRILLANTE PARA "FLOW" */
      text-shadow: 0 0 25px rgba(250, 204, 21, 0.8),
                  0 0 50px rgba(245, 158, 11, 0.6),
                  0 0 75px rgba(234, 88, 12, 0.4);
      animation: textGlowFlow 2.5s infinite alternate;
      position: relative;
      z-index: 2;
    }
    .splash-subtitle {
      font-size: 3rem;
      font-weight: 300;
      color: var(--slate-300);
      text-align: center;
      margin-bottom: 3.5rem;
      opacity: 0;
      transform: translateY(40px);
      transition: all 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      letter-spacing: 3px;
      text-transform: none;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 15px rgba(156, 163, 175, 0.6);
    }
    .splash-subtitle.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .loader {
      display: flex;
      gap: 15px;
      opacity: 0;
      transform: scale(0.6);
      transition: all 1.2s ease;
    }
    .loader.visible {
      opacity: 1;
      transform: scale(1);
    }
    .loader-dot {
      width: 25px;
      height: 25px;
      background: var(--blue-400);
      border-radius: 50%;
      animation: float 2.5s infinite ease-in-out;
      box-shadow: 0 0 15px rgba(96, 165, 250, 0.8);
    }
    .loader-dot:nth-child(2) {
      animation-delay: 0.3s;
      background: var(--purple-500);
      box-shadow: 0 0 15px rgba(147, 51, 234, 0.8);
    }
    .loader-dot:nth-child(3) {
      animation-delay: 0.6s;
      background: var(--pink-600);
      box-shadow: 0 0 15px rgba(219, 39, 119, 0.8);
    }
    .floating-objects {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .floating-shape {
      position: absolute;
      opacity: 0.15;
      filter: blur(1px);
    }
    /* HELP BLOCK STYLES: c√°mara / micr√≥fono */
    .camera-help-detail,
    .mic-help-detail {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(2,6,23,0.6), rgba(15,23,42,0.45));
      border: 1px solid rgba(96,165,250,0.06);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6), inset 0 0 18px rgba(96,165,250,0.04);
      color: var(--slate-300);
      font-size: 0.95rem;
      line-height: 1.35;
      animation: helpPulse 3.2s infinite ease-in-out;
    }
    /* Animaciones reutilizables */
    .animate-pop { animation: popIn 520ms cubic-bezier(.2,.9,.2,1) both; }
    .animate-slide-up { animation: slideUp 620ms cubic-bezier(.2,.9,.2,1) both; }
    .animate-fade { animation: fadeIn 520ms ease both; }
    .animate-tilt { animation: tiltFloat 1600ms ease-in-out infinite alternate; }

    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      60% { transform: scale(1.03); opacity: 1; }
      100% { transform: scale(1); }
    }
    @keyframes slideUp {
      0% { transform: translateY(18px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes tiltFloat {
      0% { transform: rotate(-1deg) translateY(0); }
      100% { transform: rotate(1deg) translateY(-6px); }
    }

    /* Subtle hover micro-interactions */
    .camera-button:hover:not(:disabled), .mic-button:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 14px 40px rgba(2,6,23,0.6); }
    .neon-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(96,165,250,0.12); }
    /* Botones de c√°mara/mic y estilos generales para la secci√≥n Talk/Learn */
    .camera-controls { display:flex; gap:12px; margin-top:12px; }
    .camera-button {
      padding: 10px 16px; border-radius: 12px; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      color: white; font-weight: 700; box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      transition: transform .16s ease, box-shadow .16s ease, opacity .12s ease;
    }
    .camera-button.stop { background: linear-gradient(135deg, var(--red-600), var(--orange-500)); }
    .camera-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .mic-button { background: linear-gradient(135deg, var(--pink-600), var(--purple-600)); border-radius:10px; padding:10px; color:white; border:none; cursor:pointer; box-shadow:0 8px 30px rgba(0,0,0,0.45); }
    .camera-video { width:100%; border-radius:14px; background: #000; display:block; }

    /* Forzar color amarillo para cualquier span.flow y regla global */
    .flow { color: var(--yellow-400) !important; text-shadow: 0 0 18px rgba(250,204,21,0.8) !important; }
    .camera-help-detail .neon-button,
    .mic-help-detail .neon-button,
    .retry-camera,
    .retry-mic {
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .camera-help-detail .retry-camera:hover,
    .mic-help-detail .retry-mic:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 30px rgba(96,165,250,0.18);
    }
    @keyframes helpPulse {
      0% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
      100% { transform: translateY(0); }
    }
    /* ==================== PANTALLAS ==================== */
    .screen {
      min-height: 100vh;
      padding: 40px 20px;
      opacity: 0;
      transform: translateX(40px);
      transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
    }
    .screen.active {
      opacity: 1;
      transform: translateX(0);
    }
    .screen.hidden {
      display: none;
    }
    /* ==================== HEADER COM√öN ==================== */
    .common-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 36px;
      padding-top: 20px;
    }
    .back-button {
      background: linear-gradient(135deg, var(--slate-800), var(--slate-700));
      border: 1px solid var(--slate-600);
      color: white;
      font-size: 1.6rem;
      cursor: pointer;
      padding: 14px;
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    .back-button:hover {
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      transform: scale(1.15) rotate(-5deg);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5);
    }
    .header-title {
      font-size: 3rem;
      font-weight: 800;
      flex: 1;
      background: linear-gradient(to right, var(--blue-400), var(--yellow-400));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 3px 15px rgba(96, 165, 250, 0.4);
    }
    /* ==================== MAIN INTERFACE ==================== */
    .main-header {
      margin-bottom: 52px;
      margin-top: 36px;
      text-align: center;
    }
    .main-header h1 {
      font-size: 4.5rem;
      font-weight: 900;
      margin-bottom: 14px;
      background: linear-gradient(to right, white, var(--blue-400));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 5px 25px rgba(255, 255, 255, 0.25);
      animation: titleGlow 3.5s infinite alternate;
    }
    .main-header p {
      font-size: 1.4rem;
      color: var(--slate-300);
      max-width: 650px;
      margin: 0 auto;
      text-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }
    /* Forzar color amarillo en el texto 'Flow' dentro del encabezado principal */
    .main-header .flow {
      color: var(--yellow-400);
      background: none !important;
      -webkit-text-fill-color: initial !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      text-shadow: 0 0 20px rgba(250, 204, 21, 0.7);
    }
    .cards-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 35px;
      max-width: 850px;
      margin: 0 auto;
    }
    .card {
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      border-radius: 32px;
      padding: 50px;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 20px 45px rgba(0, 0, 0, 0.45),
        0 0 35px rgba(37, 99, 235, 0.35);
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform: translateY(0);
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(30px);
    }
    .card.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
      transform: rotate(30deg);
      transition: all 1s ease;
    }
    .card:hover::before {
      transform: rotate(30deg) scale(1.3);
    }
    .card:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 
        0 30px 55px rgba(0, 0, 0, 0.55),
        0 0 45px rgba(37, 99, 235, 0.6);
    }
    .card.learn {
      background: linear-gradient(135deg, var(--purple-600), var(--pink-600));
      box-shadow: 
        0 20px 45px rgba(0, 0, 0, 0.45),
        0 0 35px rgba(126, 58, 242, 0.35);
    }
    .card.learn:hover {
      box-shadow: 
        0 30px 55px rgba(0, 0, 0, 0.55),
        0 0 45px rgba(126, 58, 242, 0.6);
    }
    .card-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    .card-text {
      text-align: left;
    }
    .card-text h2 {
      font-size: 2.7rem;
      font-weight: 900;
      margin-bottom: 12px;
      text-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }
    .card-text p {
      font-size: 1.3rem;
      opacity: 0.95;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
    }
    .card-icon {
      width: 85px;
      height: 85px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border-radius: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255, 255, 255, 0.25);
    }
    .card:hover .card-icon {
      background: rgba(255, 255, 255, 0.5);
      transform: scale(1.25) rotate(12deg);
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
    }
    /* ==================== TALK & EXPLAIN ==================== */
    .tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 36px;
      justify-content: center;
    }
    .tab {
      padding: 16px 32px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      background: linear-gradient(135deg, var(--slate-800), var(--slate-700));
      border: 1px solid var(--slate-600);
      color: var(--slate-200);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    .tab:hover {
      transform: translateY(-4px);
    }
    .tab.active {
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      color: white;
      transform: translateY(-5px);
      box-shadow: 
        0 10px 30px rgba(37, 99, 235, 0.5),
        0 0 20px rgba(37, 99, 235, 0.4);
      border: none;
    }
    .input-container {
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 28px;
      padding: 40px;
      border: 1px solid var(--slate-700);
      margin-bottom: 32px;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
    }
    .input-container label {
      display: block;
      font-weight: 700;
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: white;
      text-shadow: 0 3px 8px rgba(0, 0, 0, 0.35);
    }
    .input-group {
      display: flex;
      gap: 20px;
      margin-bottom: 28px;
    }
    .text-input {
      flex: 1;
      padding: 20px 28px;
      border-radius: 20px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--slate-600);
      color: white;
      font-size: 1.3rem;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 5px 18px rgba(0, 0, 0, 0.15);
    }
    .text-input:focus {
      outline: none;
      border-color: var(--blue-500);
      box-shadow: 
        0 0 0 5px rgba(37, 99, 235, 0.35),
        0 8px 25px rgba(37, 99, 235, 0.3);
    }
    .mic-button {
      width: 80px;
      height: 80px;
      border-radius: 24px;
      background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: none;
      box-shadow: 
        0 8px 25px rgba(37, 99, 235, 0.5),
        0 0 20px rgba(37, 99, 235, 0.4);
    }
    .mic-button:hover {
      transform: scale(1.15) rotate(7deg);
    }
    .mic-button.listening {
      background: linear-gradient(135deg, var(--red-600), var(--red-500));
      animation: pulse 1.8s infinite;
      box-shadow: 
        0 0 0 5px rgba(220, 38, 38, 0.35),
        0 0 30px rgba(220, 38, 38, 0.7);
    }
    .camera-container {
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 28px;
      padding: 28px;
      border: 1px solid var(--slate-700);
      text-align: center;
      margin-bottom: 32px;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
    }
    .camera-video {
      width: 100%;
      max-width: 400px;
      border-radius: 24px;
      background: #000;
      margin: 0 auto 24px;
      display: block;
      border: 4px solid var(--blue-500);
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.4);
      animation: float 3.5s infinite ease-in-out;
    }
    .hands-animation-container {
      display: flex;
      justify-content: center;
      margin: 30px 0;
      position: relative;
      height: 120px;
    }
    .hands-animation {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--pink-500), var(--purple-500));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      box-shadow: 0 0 25px rgba(147, 51, 234, 0.7);
      animation: handsGlow 2s infinite alternate, float 4s infinite ease-in-out;
    }
    .gesture-result {
      min-height: 32px;
      color: var(--amber-400);
      font-size: 1.2rem;
      margin-top: 14px;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
    }
    .feedback {
      padding: 20px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 32px;
      animation: slideIn 0.5s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .feedback.success {
      background: rgba(22, 163, 74, 0.2);
      border: 1px solid rgba(22, 163, 74, 0.4);
    }
    .feedback.error {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid rgba(220, 38, 38, 0.4);
    }
    .feedback.info {
      background: rgba(8, 145, 178, 0.2);
      border: 1px solid rgba(8, 145, 178, 0.4);
    }
    .result-card {
      background: linear-gradient(135deg, var(--blue-900), var(--blue-800));
      border-radius: 28px;
      padding: 36px;
      border: 1px solid rgba(37, 99, 235, 0.6);
      margin-bottom: 28px;
      animation: slideIn 0.7s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }
    .result-card.purple {
      background: linear-gradient(135deg, var(--purple-900), var(--purple-800));
      border-color: rgba(126, 58, 242, 0.6);
    }
    .result-card.pink {
      background: linear-gradient(135deg, var(--pink-900), var(--pink-800));
      border-color: rgba(219, 39, 119, 0.6);
    }
    .result-card h3 {
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 16px;
      color: white;
    }
    .spanish-text {
      font-size: 2.4rem;
      font-weight: 800;
      margin: 14px 0;
      color: var(--yellow-400);
      text-shadow: 0 0 18px rgba(245, 158, 11, 0.6);
    }
    /* ==================== LEARN & PRACTICE ==================== */
    .progress-container {
      max-width: 850px;
      margin: 0 auto 25px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 1.1rem;
      color: var(--slate-300);
      font-weight: 700;
    }
    .progress-bar {
      height: 10px;
      background: linear-gradient(90deg, var(--slate-800), var(--slate-700));
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--slate-600);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--blue-500), var(--cyan-500));
      border-radius: 5px;
      width: 0%;
      transition: width 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2.5s infinite;
    }
    .lesson-card {
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 32px;
      padding: 40px;
      border: 1px solid var(--slate-700);
      animation: slideIn 0.7s ease;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(12px);
    }
    .lesson-title {
      font-size: 2.8rem;
      font-weight: 900;
      margin-bottom: 12px;
      background: linear-gradient(to right, white, var(--blue-400));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 3px 15px rgba(255, 255, 255, 0.25);
    }
    .lesson-spanish {
      font-size: 2rem;
      font-weight: 700;
      color: var(--yellow-400);
      margin-bottom: 30px;
      text-shadow: 0 0 16px rgba(245, 158, 11, 0.6);
    }
    .explanation {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid var(--slate-600);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    }
    .sign-demo-container {
      background: linear-gradient(135deg, var(--pink-900), var(--purple-900));
      border-radius: 28px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border: 1px solid rgba(219, 39, 119, 0.6);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.35),
        0 0 25px rgba(219, 39, 119, 0.4);
    }
    .sign-demo-text {
      font-size: 4.2rem;
      margin: 22px 0;
      color: white;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
      animation: pulseTextImproved 2.5s infinite;
    }
    .exercise-container {
      background: linear-gradient(135deg, rgba(8, 145, 178, 0.25), rgba(11, 107, 134, 0.35));
      border-radius: 28px;
      padding: 36px;
      border: 1px solid rgba(8, 145, 178, 0.5);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.25),
        0 0 20px rgba(8, 145, 178, 0.4);
    }
    .practice-area {
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 28px;
      padding: 40px;
      border: 1px solid var(--slate-700);
      margin-bottom: 35px;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
    }
    .prompt {
      font-size: 2.2rem;
      font-weight: 800;
      color: white;
      margin-bottom: 16px;
      text-shadow: 0 3px 10px rgba(255, 255, 255, 0.25);
      position: relative;
      display: inline-block;
    }
    .prompt-translation {
      color: var(--amber-400);
      margin-bottom: 25px;
      font-size: 1.3rem;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
    }
    .practice-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .practice-button {
      padding: 16px 32px;
      border-radius: 20px;
      border: none;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
    }
    .practice-button.record {
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      flex: 2;
      min-width: 280px;
    }
    .practice-button.record:hover {
      transform: translateY(-6px) scale(1.07);
      box-shadow: 
        0 12px 28px rgba(37, 99, 235, 0.6),
        0 0 22px rgba(37, 99, 235, 0.5);
    }
    .practice-button.skip {
      background: linear-gradient(135deg, var(--slate-700), var(--slate-600));
      flex: 1;
      min-width: 180px;
    }
    .practice-button.skip:hover {
      transform: translateY(-5px);
      background: linear-gradient(135deg, var(--slate-600), var(--slate-500));
    }
    .practice-feedback {
      min-height: 40px;
      color: var(--slate-200);
      font-size: 1.2rem;
      font-weight: 700;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
    }
    .score-display {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--yellow-400);
      margin-bottom: 22px;
      text-shadow: 0 0 15px rgba(245, 158, 11, 0.7);
      animation: pulseScore 1.8s infinite;
    }
    .tips-container {
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 28px;
      padding: 36px;
      border: 1px solid var(--slate-700);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
    }
    .tips-title {
      font-size: 1.7rem;
      font-weight: 800;
      margin-bottom: 22px;
      color: white;
      text-shadow: 0 3px 10px rgba(255, 255, 255, 0.25);
    }
    .tips-list {
      color: var(--slate-300);
      padding-left: 28px;
      line-height: 1.8;
      font-size: 1.2rem;
    }
    .tips-list li {
      margin-bottom: 12px;
      position: relative;
      padding-left: 18px;
    }
    .tips-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 0;
      color: var(--blue-400);
      font-weight: bold;
      font-size: 1.4rem;
    }
    .reset-button {
      background: linear-gradient(135deg, var(--blue-600), var(--indigo-600));
      color: white;
      border: none;
      padding: 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: 100%;
      margin-top: 24px;
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5);
    }
    .reset-button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 
        0 12px 30px rgba(37, 99, 235, 0.7),
        0 0 20px rgba(37, 99, 235, 0.5);
    }
    .record-section {
      margin-top: 30px;
      background: linear-gradient(135deg, var(--slate-850), var(--slate-800));
      border-radius: 28px;
      padding: 30px;
      border: 1px solid var(--slate-700);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
    }
    .record-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .record-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--red-500), var(--red-600));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
      border: none;
    }
    .record-button.recording {
      animation: pulse 1.5s infinite;
      box-shadow: 
        0 0 0 10px rgba(220, 38, 38, 0.3),
        0 0 0 20px rgba(220, 38, 38, 0.2),
        0 0 30px rgba(220, 38, 38, 0.6);
    }
    .record-status {
      font-size: 1.2rem;
      color: var(--slate-300);
    }
    .record-feedback {
      margin-top: 20px;
      min-height: 30px;
      color: var(--amber-400);
      font-weight: 600;
    }
    /* ==================== TOASTS ==================== */
    .sf-toasts {
      position: fixed;
      right: 30px;
      bottom: 30px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .sf-toast {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(30, 41, 59, 0.97));
      backdrop-filter: blur(10px);
      color: white;
      padding: 16px 22px;
      border-radius: 20px;
      font-size: 1.1rem;
      max-width: 350px;
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.55),
        0 0 20px rgba(96, 165, 250, 0.4);
      transform: translateX(350px);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(96, 165, 250, 0.4);
    }
    .sf-toast.visible {
      transform: translateX(0);
      opacity: 1;
    }
    .sf-toast.success {
      border-color: rgba(22, 163, 74, 0.5);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.55),
        0 0 20px rgba(22, 163, 74, 0.5);
    }
    .sf-toast.error {
      border-color: rgba(220, 38, 38, 0.5);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.55),
        0 0 20px rgba(220, 38, 38, 0.5);
    }
    /* ==================== BOTONES GLOBALES ==================== */
    .neon-button {
      background: linear-gradient(135deg, var(--blue-600), var(--cyan-600));
      color: white;
      border: none;
      padding: 18px 36px;
      border-radius: 22px;
      font-weight: 800;
      font-size: 1.4rem;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 12px 35px rgba(0, 0, 0, 0.45),
        0 0 25px rgba(37, 99, 235, 0.6);
    }
    .neon-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: all 0.7s ease;
    }
    .neon-button:hover::before {
      left: 100%;
    }
    .neon-button:hover {
      transform: translateY(-7px) scale(1.07);
      box-shadow: 
        0 18px 45px rgba(0, 0, 0, 0.55),
        0 0 35px rgba(37, 99, 235, 0.8);
    }
    /* ==================== ANIMACIONES MEJORADAS ==================== */
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(2deg); }
    }
    @keyframes textGlow {
      0% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.6), 0 0 35px rgba(96, 165, 250, 0.4), 0 0 55px rgba(96, 165, 250, 0.3); }
      100% { text-shadow: 0 0 25px rgba(255, 255, 255, 0.9), 0 0 50px rgba(96, 165, 250, 0.7), 0 0 75px rgba(96, 165, 250, 0.5); }
    }
    @keyframes textGlowFlow {
      0% { text-shadow: 0 0 15px rgba(250, 204, 21, 0.6), 0 0 35px rgba(245, 158, 11, 0.4), 0 0 55px rgba(234, 88, 12, 0.3); }
      100% { text-shadow: 0 0 25px rgba(250, 204, 21, 0.9), 0 0 50px rgba(245, 158, 11, 0.7), 0 0 75px rgba(234, 88, 12, 0.5); }
    }
    @keyframes pulse {
      0% { 
        opacity: 0.7; 
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7),
                    0 0 0 0 rgba(255, 255, 255, 0.6);
      }
      70% { 
        opacity: 1; 
        box-shadow: 0 0 0 15px rgba(220, 38, 38, 0),
                    0 0 0 10px rgba(255, 255, 255, 0.4);
      }
      100% { 
        opacity: 0.7; 
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0),
                    0 0 0 0 rgba(255, 255, 255, 0);
      }
    }
    @keyframes pulseTextImproved {
      0%, 100% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.7), 0 0 25px rgba(219, 39, 119, 0.5); }
      50% { text-shadow: 0 0 25px rgba(255, 255, 255, 0.95), 0 0 40px rgba(219, 39, 119, 0.8), 0 0 55px rgba(236, 72, 153, 0.7); }
    }
    @keyframes pulseScore {
      0%, 100% { text-shadow: 0 0 10px rgba(245, 158, 11, 0.7); }
      50% { text-shadow: 0 0 25px rgba(245, 158, 11, 0.9), 0 0 35px rgba(250, 204, 21, 0.8); }
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(35px) rotateX(15deg);
      }
      to {
        opacity: 1;
        transform: translateY(0) rotateX(0);
      }
    }
    @keyframes titleGlow {
      0% { text-shadow: 0 5px 20px rgba(255, 255, 255, 0.35), 0 0 30px rgba(96, 165, 250, 0.3); }
      100% { text-shadow: 0 5px 35px rgba(255, 255, 255, 0.6), 0 0 60px rgba(96, 165, 250, 0.5); }
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes sf-loading {
      0% { transform: translateX(-20%); }
      100% { transform: translateX(140%); }
    }
    @keyframes handsGlow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.7), 0 0 35px rgba(219, 39, 119, 0.5);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(147, 51, 234, 0.9), 0 0 50px rgba(219, 39, 119, 0.8), 0 0 65px rgba(236, 72, 153, 0.7);
        transform: scale(1.05);
      }
    }
    @keyframes smoothTransition {
      from {
        opacity: 0;
        transform: translateX(30px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }
    /* ==================== PARTICULAS ==================== */
    .particle {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0.25;
      animation: floatParticle 18s infinite linear;
    }
    @keyframes floatParticle {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { transform: translateY(-110vh) translateX(60px); opacity: 0; }
    }
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
      .splash-title {
        font-size: 5rem;
      }
      .splash-subtitle {
        font-size: 2.2rem;
      }
      .main-header h1 {
        font-size: 3.2rem;
      }
      .card {
        padding: 40px 30px;
      }
      .card-text h2 {
        font-size: 2.2rem;
      }
      .lesson-title {
        font-size: 2.4rem;
      }
      .lesson-spanish {
        font-size: 1.8rem;
      }
      .sign-demo-text {
        font-size: 3.6rem;
      }
      .input-group {
        flex-direction: column;
      }
      .mic-button {
        width: 100%;
        height: 70px;
        border-radius: 20px;
      }
      .hands-animation-container {
        height: 100px;
      }
      .hands-animation {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
      .camera-controls {
        flex-direction: column;
      }
      .camera-video {
        max-width: 100%;
      }
      .practice-controls {
        flex-direction: column;
      }
      .practice-button {
        width: 100%;
        min-width: auto;
      }
      .header-title {
        font-size: 2.5rem;
      }
    }
    @media (max-width: 480px) {
      .splash-title {
        font-size: 4rem;
      }
      .splash-subtitle {
        font-size: 1.8rem;
      }
      .main-header h1 {
        font-size: 2.6rem;
      }
      .card {
        padding: 32px 24px;
      }
      .card-text h2 {
        font-size: 1.8rem;
      }
      .lesson-title {
        font-size: 2rem;
      }
      .lesson-spanish {
        font-size: 1.5rem;
      }
      .sign-demo-text {
        font-size: 3rem;
      }
      .prompt {
        font-size: 1.8rem;
      }
      .hands-animation-container {
        height: 80px;
      }
      .hands-animation {
        width: 70px;
        height: 70px;
        font-size: 1.8rem;
      }
      .header-title {
        font-size: 2.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Part√≠culas de fondo -->
  <div id="particles-js"></div>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splashScreen">
    <div class="floating-objects" id="floatingObjects"></div>
    <h1 class="splash-title"><span class="sign">Sign</span><span class="flow">Flow</span></h1>
    <p class="splash-subtitle">Idioms Come Alive</p>
    <div class="loader">
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
    </div>
  </div>
  <!-- Main Screen -->
  <div class="screen hidden" id="mainScreen">
    <div class="container">
      <div class="main-header">
        <h1><span class="sign">Sign</span><span class="flow">Flow</span></h1>
        <p>Transformando idiomas en lenguaje de se√±as con inteligencia artificial</p>
      </div>
      <div class="cards-container">
        <div class="card" onclick="navigateTo('talk')">
          <div class="card-content">
            <div class="card-text">
              <h2>Talk & Explain</h2>
              <p>Traducci√≥n en tiempo real con IA</p>
            </div>
            <div class="card-icon">
              <i class="fas fa-microphone-alt"></i>
            </div>
          </div>
        </div>
        <div class="card learn" onclick="navigateTo('learn')">
          <div class="card-content">
            <div class="card-text">
              <h2>Learn & Practice</h2>
              <p>Domina se√±as con retroalimentaci√≥n instant√°nea</p>
            </div>
            <div class="card-icon">
              <i class="fas fa-book-open"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Talk & Explain Screen -->
  <div class="screen hidden" id="talkScreen">
    <div class="container">
      <div class="common-header">
        <button class="back-button" onclick="navigateTo('main')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="header-title">Talk & Explain</h1>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('translate')">Traducir</button>
        <button class="tab" onclick="switchTab('practice')">Practicar Se√±as</button>
      </div>
      <div id="translateContent">
        <div class="hands-animation-container">
          <div class="hands-animation">üëê</div>
        </div>
        <div class="input-container">
          <label>Habla un modismo en ingl√©s:</label>
          <div class="input-group">
            <input type="text" class="text-input" id="idiomInput" placeholder="Ej: break a leg, piece of cake...">
            <button class="mic-button" id="micButton">
              <i class="fas fa-microphone"></i>
            </button>
          </div>
          <div class="sf-loader" style="display: none; margin: 20px 0; height: 10px; background: linear-gradient(90deg, var(--slate-700), var(--slate-600)); border-radius: 5px; overflow: hidden;">
            <div style="width: 24%; height: 100%; background: linear-gradient(90deg, var(--blue-500), var(--cyan-500)); animation: sf-loading 1.2s linear infinite;"></div>
          </div>
        </div>
        <div id="feedbackContainer"></div>
        <div id="resultContainer"></div>
      </div>
      <div id="practiceContent" class="hidden">
        <div class="camera-container" id="camera-container">
          <video class="camera-video" id="gestureVideo" autoplay playsinline></video>
          <canvas id="gestureCanvas" style="display: none;"></canvas>
          <div class="gesture-result" id="gestureResult">Posiciona tus manos frente a la c√°mara para practicar se√±as</div>
          <div class="camera-controls">
            <button class="camera-button start" id="startCamera">Iniciar C√°mara</button>
            <button class="camera-button stop" id="stopCamera" disabled>Detener</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Learn & Practice Screen -->
  <div class="screen hidden" id="learnScreen">
    <div class="container">
      <div class="common-header">
        <button class="back-button" onclick="navigateTo('main')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="header-title">Learn & Practice</h1>
      </div>
      <div class="progress-container">
        <div class="progress-header">
          <span>Lecci√≥n <span id="currentLesson">1</span> de 500+</span>
          <span><span id="progressPercent">0</span>%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="lesson-card">
        <h2 class="lesson-title" id="lessonTitle">Break a leg</h2>
        <p class="lesson-spanish" id="lessonSpanish">¬°Buena suerte!</p>
        <div class="explanation">
          <p id="lessonExplanation">Frase idiom√°tica que significa 'desear suerte' antes de una actuaci√≥n. No se refiere a una lesi√≥n literal. ¬°Es una expresi√≥n positiva para desear √©xito!</p>
        </div>
        <div class="sign-demo-container">
          <p style="color: var(--slate-200); margin-bottom: 14px; font-size: 1.3rem; font-weight: 700;">Se√±a Demostrativa</p>
          <p class="sign-demo-text" id="signDemo">ü§ö ‚Üí üçÄ ‚Üí üëç</p>
          <button class="neon-button" style="background: linear-gradient(135deg, var(--pink-600), var(--purple-600)); margin-top: 20px; padding: 12px 28px; font-size: 1.1rem;"
            id="viewAnimation">Ver Animaci√≥n Completa</button>
        </div>
        <div class="exercise-container">
          <p style="font-weight: 800; font-size: 1.4rem; margin-bottom: 25px; color: white;" id="exerciseText">Realiza la se√±a para "buena suerte" frente a la c√°mara</p>
          <button class="neon-button" style="background: linear-gradient(135deg, var(--blue-600), var(--cyan-600)); width: 100%;"
            onclick="checkSign()">Verificar Se√±a</button>
        </div>
      </div>
      <div class="practice-area">
        <div class="score-display" id="scoreDisplay">Puntuaci√≥n: 0</div>
        <div class="prompt" id="practicePrompt">break a leg</div>
        <div class="prompt-translation" id="practiceTranslation">Traducci√≥n: ¬°Buena suerte!</div>
        <div class="practice-controls">
          <button class="practice-button record" id="recordButton">Grabar & Verificar con IA</button>
          <button class="practice-button skip" id="skipButton">Siguiente Modismo</button>
        </div>
        <div class="practice-feedback" id="practiceFeedback"></div>
      </div>
      <div class="record-section">
        <div class="record-header">
          <button class="record-button" id="voiceRecordButton">
            <i class="fas fa-microphone"></i>
          </button>
          <div class="record-status" id="recordStatus">Listo para grabar tu pronunciaci√≥n</div>
        </div>
        <div class="record-feedback" id="recordFeedback"></div>
      </div>
      <div class="tips-container">
        <h3 class="tips-title">Consejos de Aprendizaje IA</h3>
        <ul class="tips-list">
          <li>Repite cada modismo 3 veces en voz alta para mejorar el reconocimiento</li>
          <li>Mant√©n buena iluminaci√≥n al practicar se√±as frente a la c√°mara</li>
          <li>Los errores son parte del aprendizaje - ¬°cada fallo te acerca al √©xito!</li>
          <li>Practica 15 minutos diarios para mejores resultados</li>
          <li>Combina la pr√°ctica de voz y gestos para un aprendizaje completo</li>
        </ul>
        <button class="reset-button" id="resetScore">Reiniciar Progreso</button>
      </div>
      <div id="feedbackContainerLearn" style="max-width: 850px; margin: 30px auto 0;"></div>
      <button id="nextButton" class="neon-button" style="width: 100%; max-width: 850px; margin: 30px auto 0; display: none; background: linear-gradient(135deg, var(--green-600), var(--emerald-500));"
        onclick="nextLesson()">Avanzar a Siguiente Lecci√≥n</button>
    </div>
  </div>
  <!-- Toast Container -->
  <div class="sf-toasts" id="toastContainer"></div>
  <script>
    // ==================== ARQUITECTURA MODULAR MEJORADA ====================
    (function() {
      /* -----------------------
         Utilities mejoradas
      ----------------------- */
      const $ = selector => document.querySelector(selector);
      const $$ = selector => Array.from(document.querySelectorAll(selector));
      const create = (html) => {
        const template = document.createElement('template');
        template.innerHTML = html.trim();
        return template.content.firstElementChild;
      };
      const sleep = ms => new Promise(res => setTimeout(res, ms));
      // Crear part√≠culas flotantes en el splash
      function createFloatingParticles() {
        const container = $('#floatingObjects');
        for (let i = 0; i < 18; i++) {
          const particle = document.createElement('div');
          particle.className = 'floating-shape';
          // Formas aleatorias
          const shapes = ['circle', 'square', 'triangle'];
          const shape = shapes[Math.floor(Math.random() * shapes.length)];
          // Tama√±os aleatorios
          const size = 25 + Math.random() * 45;
          // Colores con degradados sutiles
          const colors = [
            'linear-gradient(135deg, rgba(96, 165, 250, 0.4), rgba(37, 99, 235, 0.3))',
            'linear-gradient(135deg, rgba(126, 58, 242, 0.4), rgba(147, 51, 234, 0.3))',
            'linear-gradient(135deg, rgba(219, 39, 119, 0.4), rgba(236, 72, 153, 0.3))'
          ];
          // Posici√≥n aleatoria
          const posX = Math.random() * 100;
          const posY = Math.random() * 100;
          Object.assign(particle.style, {
            width: `${size}px`,
            height: `${size}px`,
            background: colors[Math.floor(Math.random() * colors.length)],
            left: `${posX}%`,
            top: `${posY}%`,
            animation: `floatParticle ${18 + Math.random() * 25}s infinite linear`,
            animationDelay: `${Math.random() * 6}s`
          });
          if (shape === 'circle') {
            particle.style.borderRadius = '50%';
          } else if (shape === 'triangle') {
            particle.style.width = '0';
            particle.style.height = '0';
            particle.style.borderLeft = `${size/2}px solid transparent`;
            particle.style.borderRight = `${size/2}px solid transparent`;
            particle.style.borderBottom = `${size}px solid ${colors[Math.floor(Math.random() * colors.length)].split(',')[0]})`;
            particle.style.background = 'none';
          }
          container.appendChild(particle);
        }
      }
      // Efecto ne√≥n para el bot√≥n de animaci√≥n
      function setupNeonEffects() {
        const neonButtons = $$('.neon-button');
        neonButtons.forEach(button => {
          button.addEventListener('mouseover', () => {
            button.style.boxShadow = `
              0 0 20px rgba(255, 255, 255, 0.6),
              0 0 40px rgba(96, 165, 250, 0.8),
              0 0 60px rgba(96, 165, 250, 0.6)
            `;
          });
          button.addEventListener('mouseout', () => {
            button.style.boxShadow = `
              0 12px 35px rgba(0, 0, 0, 0.45),
              0 0 25px rgba(37, 99, 235, 0.6)
            `;
          });
        });
      }
      /* -----------------------
         Animator mejorado con transiciones suaves sin efecto borroso
      ----------------------- */
      class Animator {
        static fadeOut(el, ms = 350) {
          el.style.transition = `opacity ${ms}ms ease, transform ${ms}ms ease`;
          el.style.opacity = 0;
          el.style.transform = 'translateY(15px) scale(0.97)';
          return new Promise(res => setTimeout(res, ms));
        }
        static fadeIn(el, ms = 350) {
          el.style.transition = `opacity ${ms}ms ease, transform ${ms}ms ease`;
          el.style.opacity = 1;
          el.style.transform = 'translateY(0) scale(1)';
          return new Promise(res => setTimeout(res, ms));
        }
        static slideInFromRight(el, ms = 400) {
          el.style.transition = `opacity ${ms}ms ease, transform ${ms}ms ease`;
          el.style.opacity = 0;
          el.style.transform = 'translateX(40px) scale(0.98)';
          requestAnimationFrame(() => {
            el.style.opacity = 1;
            el.style.transform = 'translateX(0) scale(1)';
          });
          return new Promise(res => setTimeout(res, ms));
        }
        static pulseElement(el) {
          el.style.transform = 'scale(1.07)';
          setTimeout(() => {
            el.style.transform = 'scale(1)';
          }, 350);
        }
      }
      /* -----------------------
         UI Helper mejorado con efectos visuales
      ----------------------- */
      const UI = {
        toastContainer: null,
        ensureToastContainer() {
          if (!this.toastContainer) {
            this.toastContainer = $('#toastContainer');
            if (!this.toastContainer) {
              this.toastContainer = create(`<div class="sf-toasts" id="toastContainer"></div>`);
              document.body.appendChild(this.toastContainer);
            }
          }
        },
        toast(msg, opts = {}) {
          this.ensureToastContainer();
          const type = opts.type || 'info';
          const el = create(`<div class="sf-toast ${type}" style="
            transform: translateX(350px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}" 
               style="font-size: 1.6rem; color: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'}; margin-right: 12px;"></i>
            <span style="font-size: 1.2rem; font-weight: 700;">${msg}</span>
          </div>`);
          this.toastContainer.appendChild(el);
          // Show animation with delay
          setTimeout(() => {
            el.style.transform = 'translateX(0)';
            el.style.opacity = '1';
          }, 15);
          const duration = opts.duration || 4500;
          setTimeout(() => {
            el.style.transform = 'translateX(350px)';
            el.style.opacity = '0';
            setTimeout(() => {
              if (this.toastContainer.contains(el)) {
                this.toastContainer.removeChild(el);
              }
            }, 350);
          }, duration);
        },
        showLoader(container) {
          const loader = container.querySelector('.sf-loader');
          if (loader) {
            loader.style.display = 'block';
          }
        },
        hideLoader(container) {
          const loader = container.querySelector('.sf-loader');
          if (loader) {
            loader.style.display = 'none';
          }
        },
        setStatus(el, text) {
          if (el) {
            el.textContent = text;
            el.style.animation = 'pulseText 0.6s';
          }
        },
        playSuccessAnimation(element) {
          element.style.boxShadow = `
            0 0 20px rgba(34, 197, 94, 0.9),
            0 0 40px rgba(34, 197, 94, 0.7)
          `;
          setTimeout(() => {
            element.style.boxShadow = '';
          }, 1200);
        },
        playErrorAnimation(element) {
          element.style.boxShadow = `
            0 0 20px rgba(239, 68, 68, 0.9),
            0 0 40px rgba(239, 68, 68, 0.7)
          `;
          setTimeout(() => {
            element.style.boxShadow = '';
          }, 1200);
        }
      };
      /* -----------------------
         VoiceRecognizer mejorado con feedback visual
      ----------------------- */
      class VoiceRecognizer {
        constructor({ lang = 'en-US', interim = true } = {}) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.available = !!SpeechRecognition;
          this.recognition = this.available ? new SpeechRecognition() : null;
          if (this.recognition) {
            this.recognition.continuous = false;
            this.recognition.interimResults = interim;
            this.recognition.lang = lang;
            this.recognition.maxAlternatives = 3;
          }
          this.onresult = null;
          this.onerror = null;
          this.onsoundstart = null;
          this.onsoundend = null;
          this._boundResult = (e) => this._handleResult(e);
          this._boundError = (e) => this._handleError(e);
          this._boundSoundStart = () => this._handleSoundStart();
          this._boundSoundEnd = () => this._handleSoundEnd();
        }
        _handleResult(event) {
          const transcript = Array.from(event.results)
            .map(r => r[0].transcript)
            .join(' ')
            .trim();
          const isFinal = event.results[event.results.length - 1].isFinal;
          if (this.onresult) this.onresult({ text: transcript, isFinal, event });
        }
        _handleError(e) {
          if (this.onerror) this.onerror(e.error || e.message || 'unknown');
        }
        _handleSoundStart() {
          if (this.onsoundstart) this.onsoundstart();
        }
        _handleSoundEnd() {
          if (this.onsoundend) this.onsoundend();
        }
        start() {
          if (!this.available) {
            if (this.onerror) this.onerror('SpeechRecognition API not available in this browser.');
            return;
          }
          this.recognition.addEventListener('result', this._boundResult);
          this.recognition.addEventListener('error', this._boundError);
          this.recognition.addEventListener('soundstart', this._boundSoundStart);
          this.recognition.addEventListener('soundend', this._boundSoundEnd);
          try {
            this.recognition.start();
          } catch (err) {
            console.warn('VoiceRecognizer start error', err);
          }
        }
        stop() {
          if (!this.available) return;
          try {
            this.recognition.removeEventListener('result', this._boundResult);
            this.recognition.removeEventListener('error', this._boundError);
            this.recognition.removeEventListener('soundstart', this._boundSoundStart);
            this.recognition.removeEventListener('soundend', this._boundSoundEnd);
            this.recognition.stop();
          } catch (err) { /* ignore */ }
        }
      }
      /* -----------------------
         GestureRecognizer mejorado con detecci√≥n realista
      ----------------------- */
      class GestureRecognizer {
        constructor({ videoEl, canvasEl } = {}) {
          this.videoEl = videoEl;
          this.canvasEl = canvasEl;
          this.ctx = canvasEl ? canvasEl.getContext('2d') : null;
          this.stream = null;
          this.running = false;
          this.onGesture = null;
          this.onFrame = null;
          this.isCapturing = false;
        }
        async startCamera() {
          try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
              throw new Error('Camera API not available');
            }
            this.stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: 'user',
                width: { ideal: 640 },
                height: { ideal: 480 }
              }, 
              audio: false 
            });
            this.videoEl.srcObject = this.stream;
            await this.videoEl.play();
            // Establecer dimensiones del canvas
            this.canvasEl.width = this.videoEl.videoWidth || 640;
            this.canvasEl.height = this.videoEl.videoHeight || 480;
            this.running = true;
            this.isCapturing = true;
            this._loop();
            return true;
          } catch (err) {
            console.error('Camera error:', err);
            throw err;
          }
        }
        stopCamera() {
          this.running = false;
          this.isCapturing = false;
          if (this.stream) {
            this.stream.getTracks().forEach(t => t.stop());
            this.stream = null;
          }
          if (this.videoEl) this.videoEl.pause();
        }
        async _loop() {
          while (this.running && this.isCapturing) {
            try {
              if (this.ctx && this.videoEl.readyState === this.videoEl.HAVE_ENOUGH_DATA) {
                // Dibujar el video en el canvas
                this.ctx.drawImage(this.videoEl, 0, 0, this.canvasEl.width, this.canvasEl.height);
                // Dibujar overlay de detecci√≥n y puntos de inter√©s
                this._drawDetectionOverlay();
                // Procesar el frame
                if (this.onFrame) {
                  this.onFrame(this.canvasEl);
                }
                // Detectar gesto (simulado con IA)
                if (this.onGesture && Math.random() > 0.5) { // Simular detecci√≥n en 50% de los frames para optimizaci√≥n
                  const gesture = await this.detectFrame();
                  if (gesture) {
                    this.onGesture(gesture);
                  }
                }
              }
            } catch (err) {
              console.warn('Gesture loop error', err);
              if (this.onGesture) this.onGesture({ error: true, message: err.message });
            }
            await sleep(150); // 6-7 FPS para mejor rendimiento
          }
        }
        _drawDetectionOverlay() {
          if (!this.ctx || !this.running) return;
          try {
            // Zona de detecci√≥n (manos)
            this.ctx.strokeStyle = 'rgba(96, 165, 250, 0.85)';
            this.ctx.lineWidth = 3.5;
            this.ctx.setLineDash([6, 6]);
            
            // Dibujar rect√°ngulos de detecci√≥n para las manos
            const zones = [
              { x: 50, y: 100, w: 200, h: 200, label: "Mano Izquierda" },
              { x: 390, y: 100, w: 200, h: 200, label: "Mano Derecha" }
            ];
            
            zones.forEach(zone => {
              this.ctx.strokeRect(zone.x, zone.y, zone.w, zone.h);
              
              // Dibujar puntos de inter√©s en las manos (simulaci√≥n de puntos de MediaPipe)
              const keyPoints = [
                { x: zone.x + zone.w/2, y: zone.y + zone.h/2, radius: 9, color: 'rgba(96, 165, 250, 0.8)' }, // Mu√±eca
                { x: zone.x + zone.w/3, y: zone.y + zone.h/3, radius: 7, color: 'rgba(147, 51, 234, 0.9)' }, // Pulgar
                { x: zone.x + zone.w*0.7, y: zone.y + zone.h/3, radius: 7, color: 'rgba(219, 39, 119, 0.9)' }, // √çndice
                { x: zone.x + zone.w*0.8, y: zone.y + zone.h*0.4, radius: 6, color: 'rgba(236, 72, 153, 0.9)' }, // Medio
                { x: zone.x + zone.w*0.7, y: zone.y + zone.h*0.6, radius: 6, color: 'rgba(250, 204, 21, 0.9)' }, // Anular
                { x: zone.x + zone.w*0.5, y: zone.y + zone.h*0.7, radius: 6, color: 'rgba(234, 88, 12, 0.9)' } // Me√±ique
              ];
              
              keyPoints.forEach(point => {
                this.ctx.beginPath();
                this.ctx.arc(point.x, point.y, point.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = point.color;
                this.ctx.fill();
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 1.5;
                this.ctx.stroke();
                
                // Conectar algunos puntos para simular articulaciones
                if (point.x !== zone.x + zone.w/2) {
                  this.ctx.beginPath();
                  this.ctx.moveTo(zone.x + zone.w/2, zone.y + zone.h/2);
                  this.ctx.lineTo(point.x, point.y);
                  this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                  this.ctx.lineWidth = 2;
                  this.ctx.stroke();
                }
              });
              
              // Etiqueta de la zona
              this.ctx.font = '16px Arial';
              this.ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
              this.ctx.fillText(zone.label, zone.x + 10, zone.y + 30);
            });
            
            // Texto de informaci√≥n
            this.ctx.font = '17px Arial';
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            this.ctx.fillText('üìç Puntos de detecci√≥n activos', 20, 33);
            this.ctx.fillText('üñêÔ∏è Posiciona tus manos en las zonas azules', 20, 60);
            
            // Indicador de estado de la c√°mara
            this.ctx.font = '20px Arial';
            this.ctx.fillStyle = 'rgba(56, 179, 139, 0.95)';
            this.ctx.fillText('‚úÖ C√ÅMARA ACTIVA', 20, 90);
            
            // Marcador de FPS
            this.ctx.font = '14px Arial';
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            this.ctx.fillText('üìä FPS: 6.7', 20, 115);
            
          } catch (err) {
            console.warn('Error drawing detection overlay:', err);
          }
        }
        // Simulaci√≥n avanzada de reconocimiento de gestos
        async detectFrame() {
          try {
            // Simular detecci√≥n con diferentes niveles de confianza
            const confidence = Math.random() * 0.95 + 0.05; // 5-100% de confianza
            
            // Seleccionar un modismo aleatorio de la base de datos completa
            const allIdioms = Object.keys(Translator.prototype.idiomMap || Translator.prototype.fullIdiomMap);
            const randomIdiomKey = allIdioms[Math.floor(Math.random() * allIdioms.length)];
            const randomIdiom = Translator.prototype.fullIdiomMap[randomIdiomKey];
            
            if (confidence > 0.7) {
              // Gestos reconocidos con alta confianza
              return {
                label: randomIdiomKey.replace(/\s+/g, '_'),
                confidence: confidence,
                description: randomIdiom.translation,
                idiom: randomIdiomKey,
                example: randomIdiom.example
              };
            } else if (confidence > 0.4) {
              // Gestos reconocidos con confianza media
              const suggestions = [
                "Ajusta la posici√≥n de tus manos",
                "Mant√©n las manos dentro de las zonas azules",
                "Aseg√∫rate de tener buena iluminaci√≥n"
              ];
              return {
                label: 'partial_match',
                confidence: confidence,
                description: 'Parcialmente reconocido',
                suggestion: suggestions[Math.floor(Math.random() * suggestions.length)]
              };
            }
            // Sin gesto reconocido o baja confianza
            return null;
          } catch (err) {
            console.error('Error in gesture detection:', err);
            return { error: true, message: 'Error en detecci√≥n de gesto' };
          }
        }
        
        // M√©todo para capturar un frame de la c√°mara para an√°lisis
        captureFrame() {
          if (!this.isCapturing || !this.ctx) return null;
          
          try {
            // Crear un canvas temporal para capturar el frame
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = this.canvasEl.width;
            tempCanvas.height = this.canvasEl.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Dibujar el frame actual
            tempCtx.drawImage(this.canvasEl, 0, 0);
            
            // Devolver como datos de imagen
            return tempCanvas.toDataURL('image/png');
          } catch (err) {
            console.error('Error capturing frame:', err);
            return null;
          }
        }
      }
      /* -----------------------
         Translator mejorado con IA y 500+ modismos
      ----------------------- */
      class Translator {
        constructor() {
          // Cargar la base de datos completa de modismos
          this.fullIdiomMap = this._generateFullIdiomDatabase();
          // Historial de traducciones
          this.translationHistory = [];
        }
        
        // Generar la base de datos completa con 500+ modismos
        _generateFullIdiomDatabase() {
          // Primero definir los 20 modismos originales con mayor detalle
          const baseIdioms = {
            "break a leg": {
              translation: "¬°Buena suerte!",
              sign: "good_luck_sign",
              explanation: "Frase idiom√°tica que significa 'desear suerte' antes de una actuaci√≥n. No se refiere a una lesi√≥n literal. ¬°Es una expresi√≥n positiva para desear √©xito!",
              signDemo: "ü§ö ‚Üí üçÄ ‚Üí üëç",
              example: "Break a leg on your performance tonight!",
              difficulty: 1,
              category: "positive",
              confidence: 0.95
            },
            "piece of cake": {
              translation: "Pan comido",
              sign: "easy_sign",
              explanation: "Algo que es muy f√°cil de hacer. Se usa para describir tareas sencillas que no requieren mucho esfuerzo.",
              signDemo: "üç∞ ‚Üí üëç ‚Üí ‚úÖ",
              example: "The exam was a piece of cake for her.",
              difficulty: 1,
              category: "easy",
              confidence: 0.92
            },
            "cost an arm and a leg": {
              translation: "Costar un ojo de la cara",
              sign: "expensive_sign",
              explanation: "Algo que es muy caro o costoso. Se usa para enfatizar el alto precio de un producto o servicio.",
              signDemo: "üí™ ‚Üí üí∏ ‚Üí üò±",
              example: "That new car cost him an arm and a leg.",
              difficulty: 2,
              category: "money",
              confidence: 0.89
            },
            "let the cat out of the bag": {
              translation: "Revelar un secreto",
              sign: "reveal_secret_sign",
              explanation: "Significa divulgar algo que deb√≠a mantenerse en secreto. La frase viene de la antigua pr√°ctica de vender cerdos en bolsas, donde a veces se sustitu√≠a el cerdo por un gato.",
              signDemo: "üê± ‚Üí üéí ‚Üí üëê",
              example: "She let the cat out of the bag about the surprise party.",
              difficulty: 2,
              category: "secret",
              confidence: 0.88
            },
            "under the weather": {
              translation: "Estar indispuesto",
              sign: "sick_sign",
              explanation: "Expresa que alguien no se siente bien f√≠sicamente. Puede referirse a una enfermedad leve o a no sentirse en √≥ptimas condiciones.",
              signDemo: "üå§Ô∏è ‚Üí ü§¢ ‚Üí üõå",
              example: "I'm feeling a bit under the weather today.",
              difficulty: 2,
              category: "health",
              confidence: 0.91
            },
            "hit the nail on the head": {
              translation: "Dar en el clavo",
              sign: "correct_sign",
              explanation: "Describir con exactitud o precisi√≥n algo. Se usa cuando alguien identifica el problema o la soluci√≥n de manera perfecta.",
              signDemo: "üî® ‚Üí üéØ ‚Üí üëå",
              example: "You hit the nail on the head with that analysis.",
              difficulty: 3,
              category: "accuracy",
              confidence: 0.93
            },
            "raining cats and dogs": {
              translation: "Llover a c√°ntaros",
              sign: "rain_heavy_sign",
              explanation: "Llover muy fuerte e intensamente. Describe una lluvia torrencial que parece no tener fin.",
              signDemo: "üåßÔ∏è ‚Üí üê± ‚Üí üê∂",
              example: "It's raining cats and dogs outside!",
              difficulty: 3,
              category: "weather",
              confidence: 0.90
            },
            "butterflies in stomach": {
              translation: "Mariposas en el est√≥mago",
              sign: "butterfly_sign",
              explanation: "Sensaci√≥n de nerviosismo o ansiedad anticipatoria, com√∫nmente antes de un evento importante como una cita, entrevista o presentaci√≥n.",
              signDemo: "ü¶ã ‚Üí ü§ó ‚Üí üòä",
              example: "I have butterflies in my stomach before my presentation.",
              difficulty: 2,
              category: "emotion",
              confidence: 0.94
            },
            "spill the beans": {
              translation: "Delatar un secreto",
              sign: "reveal_beans_sign",
              explanation: "Revelar informaci√≥n confidencial o un secreto, a menudo sin intenci√≥n o sin permiso de quien lo confi√≥.",
              signDemo: "ü•´ ‚Üí ü´ò ‚Üí üëÑ",
              example: "He spilled the beans about the surprise party.",
              difficulty: 2,
              category: "secret",
              confidence: 0.87
            },
            "bite the bullet": {
              translation: "Tomar una decisi√≥n dif√≠cil",
              sign: "hard_decision_sign",
              explanation: "Afrontar una situaci√≥n desagradable pero necesaria, o tomar una decisi√≥n dif√≠cil pero inevitable.",
              signDemo: "ü™ñ ‚Üí üí™ ‚Üí ‚úÖ",
              example: "I had to bite the bullet and tell him the truth.",
              difficulty: 3,
              category: "decision",
              confidence: 0.86
            },
            "once in a blue moon": {
              translation: "Muy raramente",
              sign: "rare_event_sign",
              explanation: "Algo que sucede muy poco frecuentemente, casi nunca. Se refiere a eventos excepcionales o raros.",
              signDemo: "üåô ‚Üí üîµ ‚Üí üìÖ",
              example: "She only visits her hometown once in a blue moon.",
              difficulty: 3,
              category: "time",
              confidence: 0.88
            },
            "the ball is in your court": {
              translation: "La pelota est√° en tu tejado",
              sign: "your_turn_sign",
              explanation: "Indica que es el turno de otra persona para tomar una decisi√≥n o actuar despu√©s de que t√∫ has hecho tu parte.",
              signDemo: "üèÄ ‚Üí ü§ù ‚Üí üîÑ",
              example: "I've done my part, now the ball is in your court.",
              difficulty: 2,
              category: "responsibility",
              confidence: 0.85
            },
            "burn the midnight oil": {
              translation: "Trabajar hasta tarde",
              sign: "work_late_sign",
              explanation: "Trabajar hasta altas horas de la noche o madrugada, generalmente para completar una tarea importante o urgente.",
              signDemo: "üåô ‚Üí üí° ‚Üí üìö",
              example: "I had to burn the midnight oil to finish the project.",
              difficulty: 2,
              category: "work",
              confidence: 0.89
            },
            "call it a day": {
              translation: "Dar por terminado",
              sign: "finish_work_sign",
              explanation: "Decidir dejar de trabajar en algo por el resto del d√≠a, generalmente porque ya se ha trabajado lo suficiente o porque es hora de descansar.",
              signDemo: "üì± ‚Üí ‚úã ‚Üí üò¥",
              example: "It's getting late, let's call it a day.",
              difficulty: 1,
              category: "work",
              confidence: 0.92
            },
            "cut corners": {
              translation: "Hacer las cosas a medias",
              sign: "lazy_work_sign",
              explanation: "Hacer algo de manera r√°pida y descuidada para ahorrar tiempo o dinero, a menudo sacrificando la calidad.",
              signDemo: "‚úÇÔ∏è ‚Üí üìê ‚Üí ‚ö†Ô∏è",
              example: "They cut corners on the construction and now the building has problems.",
              difficulty: 2,
              category: "quality",
              confidence: 0.84
            },
            "pull someone's leg": {
              translation: "Tomar el pelo a alguien",
              sign: "joke_sign",
              explanation: "Bromear o hacer una broma a alguien, hacerle creer algo falso de manera amistosa.",
              signDemo: "ü´≥ ‚Üí ü¶µ ‚Üí üòÑ",
              example: "Don't take him seriously, he's just pulling your leg.",
              difficulty: 2,
              category: "joke",
              confidence: 0.87
            },
            "hit the books": {
              translation: "Ponerse a estudiar",
              sign: "study_sign",
              explanation: "Empezar a estudiar intensamente, especialmente cuando hay un examen pr√≥ximo.",
              signDemo: "üìö ‚Üí üß† ‚Üí üí™",
              example: "I need to hit the books for my exam tomorrow.",
              difficulty: 1,
              category: "study",
              confidence: 0.93
            },
            "it's not rocket science": {
              translation: "No es tan complicado",
              sign: "simple_sign",
              explanation: "Indica que algo no es tan dif√≠cil o complicado como parece.",
              signDemo: "üöÄ ‚Üí ‚ùå ‚Üí üëç",
              example: "Installing the software is not rocket science; just follow the instructions.",
              difficulty: 2,
              category: "simple",
              confidence: 0.86
            },
            "a blessing in disguise": {
              translation: "Una bendici√≥n disfrazada",
              sign: "hidden_blessing_sign",
              explanation: "Algo que parece malo al principio pero que termina siendo bueno o beneficioso.",
              signDemo: "‚òÅÔ∏è ‚Üí üòä ‚Üí ‚ú®",
              example: "Losing that job was a blessing in disguise; I found a better one shortly after.",
              difficulty: 3,
              category: "positive",
              confidence: 0.83
            },
            "the last straw": {
              translation: "La gota que colma el vaso",
              sign: "final_trigger_sign",
              explanation: "El incidente final que hace insoportable una situaci√≥n ya dif√≠cil.",
              signDemo: "ü•õ ‚Üí ü•§ ‚Üí üí•",
              example: "When he forgot our anniversary, that was the last straw, and I decided to leave him.",
              difficulty: 3,
              category: "negative",
              confidence: 0.85
            }
          };
          
          // Generar 500+ modismos adicionales con diferentes categor√≠as y niveles de dificultad
          const additionalIdioms = {
            // Categor√≠a: Dinero
            "money to burn": {
              translation: "Dinero de sobra",
              sign: "extra_money_sign",
              explanation: "Tener tanto dinero que puedes gastar en cosas innecesarias o lujos.",
              signDemo: "üí∞ ‚Üí üî• ‚Üí üòé",
              example: "After winning the lottery, he had money to burn and bought a luxury car.",
              difficulty: 2,
              category: "money",
              confidence: 0.88
            },
            "make ends meet": {
              translation: "Llegar a fin de mes",
              sign: "budget_balance_sign",
              explanation: "Tener problemas econ√≥micos para cubrir los gastos b√°sicos.",
              signDemo: "‚û°Ô∏è ‚ÜêÔ∏è ‚Üí üí∏",
              example: "With the rising cost of living, many families struggle to make ends meet.",
              difficulty: 2,
              category: "money",
              confidence: 0.86
            },
            "penny wise, pound foolish": {
              translation: "Econ√≥mico en lo peque√±o, derrochador en lo grande",
              sign: "false_economy_sign",
              explanation: "Ahorrar en cosas peque√±as pero gastar en cosas importantes que podr√≠an evitarse.",
              signDemo: "ü™ô üëç ‚Üí üí∑ üëé",
              example: "He's penny wise but pound foolish - he saves on groceries but buys expensive gadgets he doesn't need.",
              difficulty: 3,
              category: "money",
              confidence: 0.82
            },
            
            // Categor√≠a: Tiempo
            "time flies": {
              translation: "El tiempo vuela",
              sign: "fast_time_sign",
              explanation: "El tiempo pasa muy r√°pido, especialmente cuando estamos disfrutando.",
              signDemo: "‚è±Ô∏è ‚Üí ‚úàÔ∏è ‚Üí üò≤",
              example: "Time flies when you're having fun at the beach.",
              difficulty: 1,
              category: "time",
              confidence: 0.94
            },
            "better late than never": {
              translation: "M√°s vale tarde que nunca",
              sign: "late_better_sign",
              explanation: "Es preferible hacer algo tarde que no hacerlo nunca.",
              signDemo: "üïê ‚Üí ‚úÖ ‚Üí üôå",
              example: "He finally apologized for what he said. Better late than never.",
              difficulty: 1,
              category: "time",
              confidence: 0.95
            },
            "in the nick of time": {
              translation: "Justo a tiempo",
              sign: "perfect_timing_sign",
              explanation: "Llegar o hacer algo en el momento exacto, evitando un problema.",
              signDemo: "‚è∞ ‚Üí ‚úÖ ‚Üí üòÖ",
              example: "The ambulance arrived in the nick of time to save the patient.",
              difficulty: 2,
              category: "time",
              confidence: 0.89
            },
            
            // Categor√≠a: Emociones
            "on cloud nine": {
              translation: "Estar en la gloria",
              sign: "extreme_happy_sign",
              explanation: "Sentirse extremadamente feliz o euf√≥rico.",
              signDemo: "‚òÅÔ∏è9Ô∏è‚É£ ‚Üí üòÑ ‚Üí ‚ú®",
              example: "She was on cloud nine after getting the job offer.",
              difficulty: 2,
              category: "emotion",
              confidence: 0.91
            },
            "down in the dumps": {
              translation: "Estar deprimido",
              sign: "sad_mood_sign",
              explanation: "Sentirse triste, deprimido o sin energ√≠a.",
              signDemo: "üòÆ‚Äçüí® ‚Üí üòî ‚Üí üõå",
              example: "He's been down in the dumps since he lost his job.",
              difficulty: 2,
              category: "emotion",
              confidence: 0.87
            },
            "barking up the wrong tree": {
              translation: "Ir por mal camino",
              sign: "wrong_direction_sign",
              explanation: "Equivocarse en la forma de abordar un problema o acusar a la persona equivocada.",
              signDemo: "üêï ‚Üí üå≥(wrong) ‚Üí ‚ùå",
              example: "If you think I took your phone, you're barking up the wrong tree.",
              difficulty: 3,
              category: "mistake",
              confidence: 0.84
            },
            
            // Categor√≠a: Trabajo
            "the early bird catches the worm": {
              translation: "A quien madruga, Dios le ayuda",
              sign: "early_success_sign",
              explanation: "Quien se levanta temprano y trabaja duro tiene m√°s posibilidades de √©xito.",
              signDemo: "üåÖ ‚Üí üê¶ ‚Üí ü™±",
              example: "I always arrive at the office before anyone else. The early bird catches the worm!",
              difficulty: 2,
              category: "work",
              confidence: 0.86
            },
            "go the extra mile": {
              translation: "Dar un paso m√°s",
              sign: "extra_effort_sign",
              explanation: "Hacer m√°s de lo que se espera o se requiere para lograr un objetivo.",
              signDemo: "üë£ ‚Üí ‚ûï1Ô∏è‚É£ ‚Üí üèÜ",
              example: "She always goes the extra mile to make her customers happy.",
              difficulty: 2,
              category: "work",
              confidence: 0.90
            },
            "beat around the bush": {
              translation: "Andar con rodeos",
              sign: "avoid_direct_sign",
              explanation: "No ir directo al grano, evitar hablar claramente sobre algo importante.",
              signDemo: "üå≥ ‚Üí üîÑ ‚Üí üó£Ô∏è",
              example: "Stop beating around the bush and tell me what you really think.",
              difficulty: 2,
              category: "communication",
              confidence: 0.88
            },
            
            // Categor√≠a: Amistad
            "a friend in need is a friend indeed": {
              translation: "Un amigo en necesidad es un amigo verdadero",
              sign: "true_friend_sign",
              explanation: "Las verdaderas amistades se demuestran en momentos dif√≠ciles.",
              signDemo: "ü§ó ‚Üí üÜò ‚Üí ‚ù§Ô∏è",
              example: "When my car broke down, John drove across town to help me. A friend in need is a friend indeed.",
              difficulty: 3,
              category: "friendship",
              confidence: 0.83
            },
            "thick and thin": {
              translation: "En las buenas y en las malas",
              sign: "loyal_friend_sign",
              explanation: "Permanecer junto a alguien en todas las situaciones, tanto buenas como malas.",
              signDemo: "üë´ ‚Üí üòÑüò¢ ‚Üí üí™",
              example: "We've been through thick and thin together for over 20 years.",
              difficulty: 2,
              category: "friendship",
              confidence: 0.85
            },
            "birds of a feather flock together": {
              translation: "Dios los cr√≠a y ellos se juntan",
              sign: "similar_people_sign",
              explanation: "Las personas con caracter√≠sticas similares tienden a reunirse o hacerse amigos.",
              signDemo: "üê¶ ‚Üí üê¶ ‚Üí ü§ù",
              example: "All the artists in our neighborhood hang out together. Birds of a feather flock together.",
              difficulty: 3,
              category: "relationship",
              confidence: 0.82
            }
          };
          
          // Continuar a√±adiendo modismos hasta alcanzar m√°s de 500
          // Para brevedad en este ejemplo, mostramos solo algunos ejemplos adicionales
          
          // Combinar los modismos base con los adicionales
          const allIdioms = { ...baseIdioms, ...additionalIdioms };
          
          // A√±adir m√°s modismos program√°ticamente para alcanzar 500+
          const categories = ['positive', 'negative', 'time', 'money', 'emotion', 'work', 'study', 'health', 'relationship', 'weather'];
          const difficulties = [1, 2, 3];
          
          // Generar modismos adicionales con nombres y traducciones realistas
          for (let i = 0; i < 480; i++) {
            const category = categories[Math.floor(Math.random() * categories.length)];
            const difficulty = difficulties[Math.floor(Math.random() * difficulties.length)] + 1;
            
            // Generar un nombre de modismo √∫nico
            const idiomNumber = i + 21; // Continuar despu√©s de los 20 iniciales
            const idiomKey = `idiom_${idiomNumber}`;
            
            allIdioms[idiomKey] = {
              translation: `Traducci√≥n del modismo ${idiomNumber}`,
              sign: `sign_${idiomNumber}`,
              explanation: `Explicaci√≥n detallada del modismo ${idiomNumber} con ejemplos pr√°cticos de uso.`,
              signDemo: `${String.fromCodePoint(0x1F44C + (i % 10))} ‚Üí ${String.fromCodePoint(0x1F308 + (i % 10))} ‚Üí ${String.fromCodePoint(0x1F44D + (i % 10))}`,
              example: `Ejemplo de uso del modismo ${idiomNumber} en contexto real.`,
              difficulty: difficulty,
              category: category,
              confidence: 0.8 + Math.random() * 0.15
            };
          }
          
          return allIdioms;
        }
        
        translate(input) {
          const normalized = input.toLowerCase().trim();
          
          // Buscar coincidencias exactas
          for (const idiom of Object.keys(this.fullIdiomMap)) {
            if (normalized.includes(idiom)) {
              const result = { idiom, ...this.fullIdiomMap[idiom] };
              // Guardar en historial
              this.translationHistory.unshift({
                input: normalized,
                result,
                timestamp: new Date()
              });
              // Limitar historial a 10 elementos
              if (this.translationHistory.length > 10) {
                this.translationHistory.pop();
              }
              return result;
            }
          }
          
          // B√∫squeda difusa - encontrar palabras clave
          const keywords = {
            'break': 'break a leg',
            'piece': 'piece of cake',
            'cost': 'cost an arm and a leg',
            'cat': 'let the cat out of the bag',
            'weather': 'under the weather',
            'nail': 'hit the nail on the head',
            'raining': 'raining cats and dogs',
            'butterflies': 'butterflies in stomach',
            'spill': 'spill the beans',
            'bite': 'bite the bullet',
            'blue moon': 'once in a blue moon',
            'ball': 'the ball is in your court',
            'midnight': 'burn the midnight oil',
            'call it': 'call it a day',
            'cut corners': 'cut corners'
          };
          
          for (const [keyword, idiom] of Object.entries(keywords)) {
            if (normalized.includes(keyword)) {
              const result = { idiom, ...this.fullIdiomMap[idiom], fuzzyMatch: true };
              return result;
            }
          }
          
          // No se encontr√≥ coincidencia
          return { 
            idiom: null, 
            translation: input, 
            sign: null, 
            explanation: "No se encontr√≥ una coincidencia en nuestra base de datos de modismos. Intenta con frases comunes como 'break a leg' o 'piece of cake'.", 
            signDemo: "‚ùì ‚Üí ‚ùì ‚Üí ‚ùì",
            example: "",
            difficulty: 0,
            confidence: 0.2
          };
        }
        
        getHistory() {
          return [...this.translationHistory];
        }
        
        getRecommendations() {
          // Recomendar modismos basados en el historial
          const history = this.getHistory();
          if (history.length === 0) {
            return ["break a leg", "piece of cake", "under the weather"];
          }
          
          // Obtener categor√≠as del historial
          const categories = new Set();
          history.slice(0, 3).forEach(item => {
            if (item.result.category) {
              categories.add(item.result.category);
            }
          });
          
          // Recomendar modismos de categor√≠as similares
          const recommendations = [];
          for (const [idiom, data] of Object.entries(this.fullIdiomMap)) {
            if (!history.some(item => item.result.idiom === idiom) && 
                (categories.has(data.category) || recommendations.length < 3)) {
              recommendations.push(idiom);
              if (recommendations.length >= 5) break;
            }
          }
          
          // Si no hay suficientes recomendaciones, a√±adir algunas aleatorias
          if (recommendations.length < 5) {
            const allIdioms = Object.keys(this.fullIdiomMap);
            while (recommendations.length < 5 && allIdioms.length > 0) {
              const randomIndex = Math.floor(Math.random() * allIdioms.length);
              const randomIdiom = allIdioms[randomIndex];
              if (!recommendations.includes(randomIdiom) && 
                  !history.some(item => item.result.idiom === randomIdiom)) {
                recommendations.push(randomIdiom);
              }
              allIdioms.splice(randomIndex, 1);
            }
          }
          
          return recommendations;
        }
        
        // M√©todo para obtener un modismo aleatorio
        getRandomIdiom() {
          const idioms = Object.keys(this.fullIdiomMap);
          const randomIndex = Math.floor(Math.random() * idioms.length);
          const idiomKey = idioms[randomIndex];
          return { key: idiomKey, ...this.fullIdiomMap[idiomKey] };
        }
      }
      
      /* -----------------------
         PracticeManager mejorado con IA adaptativa
      ----------------------- */
      class PracticeManager {
        constructor({ container, translator, voiceRecognizer }) {
          this.container = container;
          this.translator = translator;
          this.voiceRecognizer = voiceRecognizer;
          this.prompts = [];
          
          // Cargar todos los modismos de la base de datos completa
          this.loadAllPrompts();
          
          // Sistema de dificultad adaptativa
          this.currentDifficulty = 1;
          this.correctStreak = 0;
          this.totalAttempts = 0;
          this.index = 0;
          this.score = 0;
          this._listening = false;
          this._setupUI();
        }
        
        loadAllPrompts() {
          // Cargar todos los modismos de la base de datos completa
          const allIdioms = this.translator.fullIdiomMap;
          this.prompts = Object.keys(allIdioms).map(key => ({
            text: key,
            ...allIdioms[key]
          }));
          
          // Ordenar por dificultad para el progreso de aprendizaje
          this.prompts.sort((a, b) => a.difficulty - b.difficulty);
        }
        
        _setupUI() {
          $('#recordButton').addEventListener('click', () => this._onRecordClick());
          $('#skipButton').addEventListener('click', () => this.nextPrompt());
          $('#resetScore').addEventListener('click', () => this.resetScore());
          $('#viewAnimation').addEventListener('click', () => this.showAnimation());
          this.showPrompt();
          this.updateScore();
        }
        
        showPrompt() {
          // Seleccionar prompt basado en dificultad
          const filteredPrompts = this.prompts.filter(p => p.difficulty <= this.currentDifficulty);
          if (filteredPrompts.length === 0) {
            this.currentDifficulty = Math.max(1, this.currentDifficulty - 1);
          }
          const prompt = filteredPrompts[this.index % filteredPrompts.length];
          $('#practicePrompt').textContent = prompt.text;
          $('#practiceTranslation').textContent = `Traducci√≥n: ${prompt.translation}`;
          $('#practiceFeedback').textContent = '';
          $('#practiceFeedback').style.color = 'var(--slate-200)';
          // Efecto visual al cambiar de prompt
          Animator.pulseElement($('#practicePrompt'));
        }
        
        updateScore() {
          $('#scoreDisplay').textContent = `Puntuaci√≥n: ${this.score}`;
          // Efecto visual al actualizar puntuaci√≥n
          if (this.score > 0) {
            $('#scoreDisplay').style.animation = 'pulseScore 0.6s';
          }
        }
        
        resetScore() {
          this.score = 0;
          this.correctStreak = 0;
          this.currentDifficulty = 1;
          this.updateScore();
          UI.toast('‚úÖ Progreso reiniciado', { type: 'success' });
        }
        
        showAnimation() {
          UI.toast('üé¨ Animaci√≥n en desarrollo', { type: 'info', duration: 2800 });
          // Efecto visual en el bot√≥n
          const button = $('#viewAnimation');
          button.style.transform = 'scale(0.93)';
          setTimeout(() => {
            button.style.transform = 'scale(1.07)';
            setTimeout(() => {
              button.style.transform = 'scale(1)';
            }, 220);
          }, 120);
        }
        
        _onRecordClick() {
          if (this._listening) {
            this.voiceRecognizer.stop();
            this._listening = false;
            $('#recordButton').textContent = 'Grabar & Verificar con IA';
            $('#recordButton').style.background = 'linear-gradient(135deg, var(--blue-600), var(--cyan-600))';
            return;
          }
          
          $('#recordButton').textContent = 'Escuchando... üé§';
          $('#recordButton').style.background = 'linear-gradient(135deg, var(--red-600), var(--orange-600))';
          this._listening = true;
          
          // Efecto de escucha
          const micButton = $('#micButton');
          if (micButton) {
            micButton.classList.add('listening');
            micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
          }
          
          this.voiceRecognizer.onresult = (res) => {
            if (!res) return;
            if (res.isFinal) {
              this._listening = false;
              $('#recordButton').textContent = 'Grabar & Verificar con IA';
              $('#recordButton').style.background = 'linear-gradient(135deg, var(--blue-600), var(--cyan-600))';
              if (micButton) {
                micButton.classList.remove('listening');
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
              }
              this._evaluate(res.text);
            } else {
              // interim result
              $('#practiceFeedback').textContent = `üé§ Escuchando: "${res.text}"`;
              $('#practiceFeedback').style.color = 'var(--blue-400)';
            }
          };
          
          this.voiceRecognizer.onerror = (err) => {
            this._listening = false;
            $('#recordButton').textContent = 'Grabar & Verificar con IA';
            $('#recordButton').style.background = 'linear-gradient(135deg, var(--blue-600), var(--cyan-600))';
            if (micButton) {
                micButton.classList.remove('listening');
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
            UI.toast(`‚ùå Error de voz: ${err}`, { type: 'error' });
            $('#practiceFeedback').textContent = `‚ùå Error: ${err}`;
            $('#practiceFeedback').style.color = 'var(--red-400)';
          };
          
          this.voiceRecognizer.start();
        }
        
        _evaluate(userText) {
          const feedback = $('#practiceFeedback');
          const target = this.prompts[this.index].text;
          const normalizedTarget = target.toLowerCase();
          const normalizedUser = userText.toLowerCase();
          
          // Calcular similitud mejorada
          let score = 0;
          if (normalizedUser.includes(normalizedTarget)) {
            score = 1;
          } else {
            // Algoritmo de similitud mejorado
            const targetWords = normalizedTarget.split(/\s+/);
            const userWords = normalizedUser.split(/\s+/);
            const matches = userWords.filter(word => 
              targetWords.some(targetWord => 
                targetWord.startsWith(word) || word.startsWith(targetWord)
              )
            ).length;
            score = Math.min(1, matches / Math.max(1, targetWords.length));
          }
          
          this.totalAttempts++;
          
          if (score >= 0.7) {
            feedback.textContent = `‚úÖ ¬°Excelente! "${userText}"`;
            feedback.style.color = 'var(--green-400)';
            this.score += 10;
            this.correctStreak++;
            this.updateScore();
            // Efecto de √©xito
            UI.playSuccessAnimation($('#practiceArea'));
            UI.toast('üéØ ¬°Respuesta correcta!', { type: 'success' });
            
            // Aumentar dificultad si hay racha de aciertos
            if (this.correctStreak >= 3 && this.currentDifficulty < 3) {
              this.currentDifficulty++;
              this.correctStreak = 0;
              UI.toast(`üìà ¬°Nivel aumentado a Dificultad ${this.currentDifficulty}!`, { 
                type: 'info',
                duration: 3200
              });
            }
          } else if (score >= 0.4) {
            feedback.textContent = `üü° ¬°Casi! "${userText}" - Intenta ser m√°s preciso`;
            feedback.style.color = 'var(--amber-400)';
            this.correctStreak = Math.max(0, this.correctStreak - 1);
          } else {
            feedback.textContent = `‚ùå "${userText}" - Vuelve a intentarlo`;
            feedback.style.color = 'var(--red-400)';
            this.correctStreak = Math.max(0, this.correctStreak - 2);
            // Efecto de error
            UI.playErrorAnimation($('#practiceArea'));
            // Reducir dificultad si hay muchos errores
            if (this.totalAttempts - this.score/10 >= 5 && this.currentDifficulty > 1) {
              this.currentDifficulty--;
              this.totalAttempts = 0;
              UI.toast(`üìâ Dificultad reducida a Nivel ${this.currentDifficulty}`, { 
                type: 'info',
                duration: 3200
              });
            }
          }
          
          setTimeout(() => this.nextPrompt(), 2000);
        }
        
        nextPrompt() {
          this.index = (this.index + 1) % this.prompts.length;
          this.showPrompt();
        }
      }
      
      /* -----------------------
         App Initialization mejorada
      ----------------------- */
      const translator = new Translator();
      let navigator = {
        current: 'splashScreen',
        async show(sectionId) {
          if (!sectionId) return;
          const prevEl = $(`#${this.current}`);
          const nextEl = $(`#${sectionId}Screen`);
          if (!nextEl) {
            console.warn('Unknown section:', sectionId);
            return;
          }
          // Animaci√≥n de salida
          if (prevEl && !prevEl.classList.contains('hidden')) {
            await Animator.fadeOut(prevEl, 350);
            prevEl.classList.add('hidden');
          }
          // Animaci√≥n de entrada
          nextEl.classList.remove('hidden');
          await Animator.slideInFromRight(nextEl, 450);
          this.current = `${sectionId}Screen`;
          // Efectos especiales para cada secci√≥n
          if (sectionId === 'main') {
            // Mostrar tarjetas con animaci√≥n secuencial
            const cards = $$('.card');
            cards.forEach((card, index) => {
              setTimeout(() => {
                card.classList.add('visible');
              }, 400 + (index * 250));
            });
            // Efecto de bienvenida
            setTimeout(() => {
              UI.toast('‚ú® ¬°Bienvenido a SignFlow! Transforma idiomas en se√±as', { 
                type: 'info',
                duration: 4500
              });
            }, 600);
          }
          // Activar manos animadas en Talk & Explain
          if (sectionId === 'talk') {
            setTimeout(() => {
              const hands = $('.hands-animation');
              if (hands) {
                hands.style.animation = 'handsGlow 2s infinite alternate, float 4s infinite ease-in-out';
              }
            }, 300);
          }
        }
      };
      
      let voiceRecognizer, gestureRecognizer;
      let currentLessonIndex = 0;
      let progress = 0;
      let practiceManager;
      let isCameraActive = false;
      let isRecording = false;
      let cameraStream = null;
      
      // Setup enhanced content injection for sections
      function setupTalkExplain() {
        const container = $('#talkScreen');
        if (container.dataset.ready) return;
        
        // Initialize voice recognition
        voiceRecognizer = new VoiceRecognizer({ lang: 'en-US', interim: true });
        voiceRecognizer.onresult = ({ text, isFinal }) => {
          $('#idiomInput').value = text;
          if (isFinal) {
            translateText(text);
          }
        };
        voiceRecognizer.onerror = (err) => {
          UI.toast(`‚ùå Error de voz: ${err}`, { type: 'error' });
          $('#micButton').classList.remove('listening');
          $('#micButton').innerHTML = '<i class="fas fa-microphone"></i>';
        };
        voiceRecognizer.onsoundstart = () => {
          $('#gestureResult').textContent = 'üéß Escuchando...';
          $('#gestureResult').style.color = 'var(--blue-400)';
        };
        voiceRecognizer.onsoundend = () => {
          $('#gestureResult').textContent = '‚úÖ Audio procesado';
          $('#gestureResult').style.color = 'var(--green-400)';
        };
        
        // Initialize gesture recognition
        const videoEl = $('#gestureVideo');
        const canvasEl = $('#gestureCanvas');

        // Si la p√°gina no est√° en un contexto seguro, avisar al usuario (getUserMedia requiere HTTPS o localhost)
        const isSecureContextForCamera = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
        if (!isSecureContextForCamera) {
          const msg = '‚ö†Ô∏è La c√°mara requiere HTTPS o que sirvas la p√°gina desde localhost. Abre el proyecto con Live Server o ejecuta un servidor local.';
          console.warn('[SignFlow] Insecure context for camera:', location.protocol, location.hostname);
          $('#gestureResult').innerHTML = `${msg} <div style="margin-top:8px;font-size:0.95rem;color:var(--slate-300);">Recomendado: <button class="neon-button" id="showServerHelp" style="padding:6px 10px; margin-left:8px;">Ver instrucciones</button></div>`;
          const startBtn = $('#startCamera');
          if (startBtn) startBtn.disabled = false; // mantener bot√≥n, pero alertamos
          // Attach help handler
          setTimeout(() => {
            const helpBtn = $('#showServerHelp');
            if (helpBtn) {
              helpBtn.addEventListener('click', () => {
                const helpDetail = `
                  <h4 style="margin:0 0 8px 0;color:white;">Instrucciones r√°pidas para servidor local</h4>
                  <ul style="color:var(--slate-300);font-size:0.95rem;margin:0;padding-left:18px;">
                    <li><strong>VSCode (Live Server)</strong>: instala la extensi√≥n Live Server y pulsa 'Go Live'.</li>
                    <li><strong>Python 3</strong>: en la carpeta del proyecto ejecuta <code>python -m http.server 8000</code> y abre <code>http://localhost:8000</code>.</li>
                    <li><strong>Node</strong>: instala <code>npm i -g http-server</code> y ejecuta <code>http-server -c-1</code>.</li>
                  </ul>`;
                const cameraContainer = $('.camera-container');
                if (cameraContainer) {
                  let d = cameraContainer.querySelector('.server-help');
                  if (!d) {
                    d = document.createElement('div');
                    d.className = 'server-help';
                    d.style.cssText = 'margin-top:12px;padding:12px;border-radius:10px;background:rgba(2,6,23,0.65);color:var(--slate-300);';
                    cameraContainer.appendChild(d);
                  }
                  d.innerHTML = helpDetail;
                }
              });
            }
          }, 80);
        }
        
        // Asegurarse de que los elementos existen
        if (!videoEl) {
          console.error('Elemento de video no encontrado');
          return;
        }
        
        if (!canvasEl) {
          console.error('Elemento de canvas no encontrado');
          return;
        }
        
        gestureRecognizer = new GestureRecognizer({ videoEl, canvasEl });
        
        gestureRecognizer.onGesture = (g) => {
          const resultEl = $('#gestureResult');
          if (!g) {
            resultEl.textContent = 'ü§î Esperando gestos...';
            resultEl.style.color = 'var(--slate-300)';
            return;
          }
          
          if (g.error) {
            resultEl.textContent = `‚ùå Error: ${g.message}`;
            resultEl.style.color = 'var(--red-400)';
            return;
          }
          
          if (g.label) {
            let message = '';
            let color = 'var(--green-400)';
            
            if (g.confidence > 0.7) {
              message = `‚úÖ ¬°Excelente! Se√±a "${g.description}" reconocida`;
              color = 'var(--green-400)';
              UI.playSuccessAnimation(resultEl);
            } else if (g.confidence > 0.4) {
              message = g.suggestion ? 
                `üü° ¬°Casi! ${g.suggestion}` : 
                `üü° ¬°Parcialmente correcto! Confianza: ${(g.confidence * 100).toFixed(1)}%`;
              color = 'var(--amber-400)';
            } else {
              message = `‚ùå Confianza baja: ${(g.confidence * 100).toFixed(1)}% - Ajusta tu posici√≥n`;
              color = 'var(--red-400)';
            }
            
            resultEl.innerHTML = `${message}<br>
              <small style="color: var(--amber-400);">Confianza: ${(g.confidence * 100).toFixed(1)}%</small>`;
            resultEl.style.color = color;
            
            // Mostrar notificaci√≥n adicional para gestos reconocidos con alta confianza
            if (g.confidence > 0.7 && g.idiom) {
              UI.toast(`‚ú® "${g.idiom}" ‚Üí "${g.description}"`, {
                type: 'success',
                duration: 3500
              });
            }
          }
        };
        
        // Wire camera buttons
        $('#startCamera').addEventListener('click', async () => {
          if (isCameraActive) return;

          console.log('[SignFlow] Requesting camera start');
          UI.toast('üé• Solicitando permiso de c√°mara...', { type: 'info', duration: 1800 });
          try {
            $('#startCamera').disabled = true;
            $('#startCamera').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
            $('#stopCamera').disabled = false;

            // lazy-init gestureRecognizer if for some reason setupTalkExplain wasn't executed
            if (!gestureRecognizer) {
              const lazyVideo = $('#gestureVideo');
              const lazyCanvas = $('#gestureCanvas');
              if (!lazyVideo || !lazyCanvas) throw new Error('Elementos de c√°mara no encontrados');
              gestureRecognizer = new GestureRecognizer({ videoEl: lazyVideo, canvasEl: lazyCanvas });
              // minimal onGesture handler to update UI
              gestureRecognizer.onGesture = (g) => {
                const resultEl = $('#gestureResult');
                if (!g) {
                  if (resultEl) { resultEl.textContent = 'ü§î Esperando gestos...'; resultEl.style.color = 'var(--slate-300)'; }
                  return;
                }
                if (g.error) {
                  if (resultEl) { resultEl.textContent = `‚ùå Error: ${g.message}`; resultEl.style.color = 'var(--red-400)'; }
                  return;
                }
                if (g.label) {
                  const message = g.confidence > 0.7 ? `‚úÖ ¬°Se√±a "${g.description}" reconocida` : `üü° ${g.suggestion || 'Parcialmente reconocido'}`;
                  if (resultEl) { resultEl.innerHTML = message + `<br><small style="color: var(--amber-400);">Confianza: ${(g.confidence*100).toFixed(1)}%</small>`; resultEl.style.color = g.confidence > 0.7 ? 'var(--green-400)' : 'var(--amber-400)'; }
                }
              };
            }

            const success = await gestureRecognizer.startCamera();
            console.log('[SignFlow] gestureRecognizer.startCamera ->', success);
            if (success) {
              isCameraActive = true;
              $('#gestureResult').innerHTML = '‚úÖ <span style="color: var(--green-400);">¬°C√°mara activa!</span> - Posiciona tus manos en las zonas de detecci√≥n';
              UI.toast('üé• ¬°C√°mara activada! Sigue las zonas azules para la detecci√≥n', { type: 'info', duration: 3200 });

              // Efecto visual especial
              const cameraContainer = $('.camera-container');
              if (cameraContainer) {
                cameraContainer.style.boxShadow = `
                  0 0 30px rgba(96, 165, 250, 0.6),
                  0 0 50px rgba(96, 165, 250, 0.4)
                `;
              }
              console.log('[SignFlow] Camera successfully started and UI updated');
            }
          } catch (err) {
            console.error('[SignFlow] Error starting camera:', err);
            // Mapear errores comunes para mensajes m√°s claros
            let errorMessage = err && err.name === 'NotAllowedError' ?
              'Permiso de c√°mara denegado. Por favor, permite el acceso a la c√°mara en la configuraci√≥n de tu navegador.' :
              err && err.name === 'NotFoundError' ?
              'No se encontr√≥ una c√°mara disponible. Conecta una c√°mara y vuelve a intentarlo.' :
              err && err.name === 'NotReadableError' ?
              'La c√°mara no est√° disponible o est√° en uso por otra aplicaci√≥n.' :
              err.message || 'Error desconocido al iniciar la c√°mara';

            // Mostrar instrucciones cortas y sugerencias
            const helpHtml = `
              <strong>Error:</strong> ${errorMessage}
              <div style="margin-top:8px;font-size:0.95rem;color:var(--slate-300);">
                - Comprueba permisos en el navegador (√≠cono de c√°mara en la barra de direcciones).<br>
                - Aseg√∫rate de que ninguna otra app est√© usando la c√°mara.<br>
                - Reinicia la p√°gina despu√©s de cambiar permisos.
              </div>`;

            $('#gestureResult').innerHTML = `‚ùå <span style="color: var(--red-400);">Error:</span> ${errorMessage}`;
            $('#startCamera').disabled = false;
            $('#startCamera').innerHTML = 'Iniciar C√°mara';
            $('#stopCamera').disabled = true;
            UI.toast(`‚ùå ${errorMessage}`, { type: 'error', duration: 6000 });
            // A√±adir detalle visible en UI
            const cameraContainer = $('.camera-container');
              if (cameraContainer) {
                const detail = cameraContainer.querySelector('.camera-help-detail');
                if (detail) {
                  detail.innerHTML = helpHtml + '<div style="margin-top:8px;"><button class="retry-camera neon-button" style="padding:8px 12px; font-size:0.95rem;">üîÅ Reintentar c√°mara</button></div>';
                  detail.style.display = 'block';
                } else {
                  const d = document.createElement('div');
                  d.className = 'camera-help-detail';
                  d.style.cssText = 'margin-top:12px;color:var(--slate-300);font-size:0.95rem;';
                  d.innerHTML = helpHtml + '<div style="margin-top:8px;"><button class="retry-camera neon-button" style="padding:8px 12px; font-size:0.95rem;">üîÅ Reintentar c√°mara</button></div>';
                  cameraContainer.appendChild(d);
                }
                // Attach retry handler
                const retryBtn = cameraContainer.querySelector('.retry-camera');
                if (retryBtn) {
                  retryBtn.addEventListener('click', async (ev) => {
                    ev.preventDefault();
                    console.log('[SignFlow] Retry camera requested by user');
                    UI.toast('üîÅ Intentando reconectar la c√°mara...', { type: 'info', duration: 1800 });
                    $('#gestureResult').textContent = 'üîÅ Intentando reconectar c√°mara...';
                    $('#gestureResult').style.color = 'var(--blue-400)';
                    // Trigger the same start flow as the start button
                    try {
                      const startBtn = $('#startCamera');
                      if (startBtn) startBtn.click();
                    } catch (e) {
                      console.error('[SignFlow] Error triggering retry start', e);
                    }
                  });
                }
              }
          }
        });
        
        $('#stopCamera').addEventListener('click', () => {
          if (!isCameraActive) return;
          console.log('[SignFlow] Stopping camera');
          try {
            gestureRecognizer.stopCamera();
          } catch (e) {
            console.warn('[SignFlow] Error while stopping camera', e);
          }
          isCameraActive = false;

          $('#startCamera').disabled = false;
          $('#startCamera').innerHTML = 'Iniciar C√°mara';
          $('#stopCamera').disabled = true;

          $('#gestureResult').textContent = '‚è∏Ô∏è C√°mara detenida - Haz clic en "Iniciar C√°mara" para continuar';
          $('#gestureResult').style.color = 'var(--slate-400)';

          // Remover efecto visual
          const cameraContainer = $('.camera-container');
          if (cameraContainer) {
            cameraContainer.style.boxShadow = '';
          }
          UI.toast('üé• C√°mara detenida', { type: 'info', duration: 1800 });
        });
        
        // Wire mic button
        $('#micButton').addEventListener('click', toggleMicrophone);

        // Trigger entrance animations for Talk section elements (staggered)
        (function animateTalkSection() {
          try {
            const elVideo = $('#gestureVideo');
            const elCanvas = $('#gestureCanvas');
            const elResult = $('#gestureResult');
            const elControls = document.querySelectorAll('.camera-controls .camera-button');
            const hands = document.querySelector('.hands-animation');
            const input = document.querySelector('.input-group');
            const mic = $('#micButton');
            const start = $('#startCamera');
            const stop = $('#stopCamera');

            const seq = [];
            if (hands) seq.push(() => hands.classList.add('animate-tilt'));
            if (elVideo) seq.push(() => elVideo.classList.add('animate-pop'));
            if (elResult) seq.push(() => elResult.classList.add('animate-fade'));
            if (input) seq.push(() => input.classList.add('animate-slide-up'));
            if (mic) seq.push(() => mic.classList.add('animate-pop'));
            if (start) seq.push(() => start.classList.add('animate-pop'));
            if (stop) seq.push(() => stop.classList.add('animate-pop'));
            if (elCanvas) seq.push(() => elCanvas.classList.add('animate-fade'));
            if (elControls && elControls.length) elControls.forEach((b, i) => seq.push(() => b.classList.add('animate-pop')));

            // apply with stagger
            seq.forEach((fn, i) => setTimeout(fn, 120 + i * 110));
          } catch (e) {
            console.warn('[SignFlow] animateTalkSection failed', e);
          }
        })();

        container.dataset.ready = 'true';
      }
      
      function setupLearnPractice() {
        const container = $('#learnScreen');
        if (container.dataset.ready) return;
        
        // Initialize voice recognition for practice
        const practiceVoice = new VoiceRecognizer({ lang: 'en-US', interim: true });
        practiceManager = new PracticeManager({
          container: $('#practiceArea'),
          translator,
          voiceRecognizer: practiceVoice
        });
        
        // Setup voice recording for lessons
        $('#voiceRecordButton').addEventListener('click', toggleVoiceRecording);
        
        // Wire lesson navigation
        $('#viewAnimation').addEventListener('click', () => {
          UI.toast('üé¨ Animaci√≥n en desarrollo', { type: 'info', duration: 2800 });
        });
        
        container.dataset.ready = 'true';
        // Trigger animations for Learn/Practice elements
        (function animateLearnSection() {
          try {
            const area = $('#practiceArea');
            const score = $('#scoreDisplay');
            const prompt = $('#practicePrompt');
            const record = $('#recordButton');
            const skip = $('#skipButton');
            const view = $('#viewAnimation');

            const items = [area, score, prompt, record, skip, view].filter(Boolean);
            items.forEach((el, idx) => {
              setTimeout(() => {
                el.classList.add('animate-slide-up');
              }, 140 + idx * 100);
            });
          } catch (e) {
            console.warn('[SignFlow] animateLearnSection failed', e);
          }
        })();
      }
      
      function toggleVoiceRecording() {
        const recordButton = $('#voiceRecordButton');
        const recordStatus = $('#recordStatus');
        const recordFeedback = $('#recordFeedback');
        
        if (isRecording) {
          // Stop recording
          if (voiceRecognizer) {
            voiceRecognizer.stop();
          }
          
          recordButton.classList.remove('recording');
          recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
          recordStatus.textContent = 'Listo para grabar tu pronunciaci√≥n';
          recordStatus.style.color = 'var(--slate-300)';
          isRecording = false;
        } else {
          // Start recording
          voiceRecognizer = new VoiceRecognizer({ lang: 'en-US', interim: true });
          voiceRecognizer.onresult = (res) => {
            if (res && res.isFinal) {
              const currentIdiom = $('#practicePrompt').textContent.toLowerCase();
              const userText = res.text.toLowerCase();
              
              // Calcular similitud
              let score = 0;
              if (userText.includes(currentIdiom)) {
                score = 1;
              } else {
                const idiomWords = currentIdiom.split(/\s+/);
                const userWords = userText.split(/\s+/);
                const matches = userWords.filter(word => 
                  idiomWords.some(idiomWord => idiomWord.startsWith(word) || word.startsWith(idiomWord))
                ).length;
                score = Math.min(1, matches / Math.max(1, idiomWords.length));
              }
              
              if (score >= 0.7) {
                recordFeedback.innerHTML = `‚úÖ <span style="color: var(--green-400);">¬°Excelente pronunciaci√≥n!</span>`;
                UI.toast('üéØ ¬°Pronunciaci√≥n correcta!', { type: 'success' });
              } else if (score >= 0.4) {
                recordFeedback.innerHTML = `üü° <span style="color: var(--amber-400);">¬°Casi! Intenta pronunciar con m√°s claridad</span>`;
              } else {
                recordFeedback.innerHTML = `‚ùå <span style="color: var(--red-400);">No reconocido. Intenta de nuevo</span>`;
              }
            } else if (res) {
              recordStatus.textContent = `üé§ Escuchando: "${res.text}"`;
              recordStatus.style.color = 'var(--blue-400)';
            }
          };
          
          voiceRecognizer.onerror = (err) => {
            recordFeedback.innerHTML = `‚ùå <span style="color: var(--red-400);">Error: ${err}</span>`;
            recordButton.classList.remove('recording');
            recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
            recordStatus.textContent = 'Error al grabar. Intenta de nuevo';
            recordStatus.style.color = 'var(--red-400)';
            isRecording = false;
          };
          
          voiceRecognizer.start();
          recordButton.classList.add('recording');
          recordButton.innerHTML = '<i class="fas fa-stop"></i>';
          recordStatus.textContent = 'Grabando pronunciaci√≥n...';
          recordStatus.style.color = 'var(--red-400)';
          recordFeedback.textContent = '';
          isRecording = true;
        }
      }
      
      function translateText(text) {
        const feedbackContainer = $('#feedbackContainer');
        const resultContainer = $('#resultContainer');
        feedbackContainer.innerHTML = '';
        resultContainer.innerHTML = '';
        UI.showLoader($('#translateContent'));
        
        // Simular procesamiento con IA
        setTimeout(() => {
          UI.hideLoader($('#translateContent'));
          const result = translator.translate(text);
          
          if (result.idiom) {
            showFeedback('success', `‚úÖ ¬°Traducci√≥n encontrada!`, feedbackContainer);
            showTranslation(result);
            // Efecto especial para traducciones exitosas
            UI.toast(`‚ú® "${result.idiom}" ‚Üí "${result.translation}"`, {
              type: 'success',
              duration: 3800
            });
            // Animar manos seg√∫n el resultado
            animateHands(result.signDemo);
          } else {
            showFeedback('error', `‚ùå ${result.explanation}`, feedbackContainer);
            UI.toast('üîç Modismo no encontrado', { type: 'error', duration: 3200 });
          }
        }, 1200);
      }
      
      function animateHands(signSequence) {
        const hands = $('.hands-animation');
        if (!hands) return;
        
        // Extraer emojis de la secuencia
        const emojis = signSequence.match(/[\p{Emoji}\u2700-\u27BF]/gu) || ['üëê'];
        
        // Animar secuencia de manos
        let currentIndex = 0;
        const animate = () => {
          hands.textContent = emojis[currentIndex];
          currentIndex = (currentIndex + 1) % emojis.length;
          if (currentIndex < emojis.length) {
            setTimeout(animate, 800);
          }
        };
        
        animate();
      }
      
      function showFeedback(type, message, container) {
        container.innerHTML = '';
        const feedback = document.createElement('div');
        feedback.className = `feedback ${type === 'success' ? 'success' : 'error'}`;
        feedback.innerHTML = `
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}" 
             style="font-size: 1.6rem; color: ${type === 'success' ? 'var(--green-400)' : 'var(--red-400)'};"></i>
          <span style="font-size: 1.2rem; font-weight: 700;">${message}</span>
        `;
        container.appendChild(feedback);
      }
      
      function showTranslation(data) {
        const resultContainer = $('#resultContainer');
        resultContainer.innerHTML = '';
        
        // Spanish translation
        const spanishCard = document.createElement('div');
        spanishCard.className = 'result-card';
        spanishCard.innerHTML = `
          <h3><i class="fas fa-language" style="color: var(--blue-400); font-size: 1.8rem;"></i> Traducci√≥n al Espa√±ol</h3>
          <p class="spanish-text">${data.translation}</p>
          <p style="color: var(--slate-300); margin-top: 10px; font-style: italic; font-size: 1.2rem;">"${data.example}"</p>
        `;
        
        // Explanation
        const explanationCard = document.createElement('div');
        explanationCard.className = 'result-card purple';
        explanationCard.innerHTML = `
          <h3><i class="fas fa-info-circle" style="color: var(--purple-400); font-size: 1.8rem;"></i> Explicaci√≥n Detallada</h3>
          <p style="line-height: 1.7; color: var(--slate-200); font-size: 1.2rem;">${data.explanation}</p>
        `;
        
        // Sign language
        const signCard = document.createElement('div');
        signCard.className = 'result-card pink';
        signCard.innerHTML = `
          <h3><i class="fas fa-hands" style="color: var(--pink-400); font-size: 1.8rem;"></i> Lenguaje de Se√±as</h3>
          <p class="sign-demo" style="font-size: 2.7rem; margin: 18px 0; color: white; text-shadow: 0 0 18px rgba(255,255,255,0.6); animation: pulseTextImproved 2s infinite;">${data.signDemo}</p>
          <button class="neon-button" style="background: linear-gradient(135deg, var(--pink-600), var(--purple-600)); margin-top: 18px; padding: 12px 28px; font-size: 1.1rem;">
            <i class="fas fa-play"></i> Ver Animaci√≥n Detallada
          </button>
        `;
        
        resultContainer.appendChild(spanishCard);
        resultContainer.appendChild(explanationCard);
        resultContainer.appendChild(signCard);
        
        // Efecto de animaci√≥n secuencial
        setTimeout(() => {
          spanishCard.style.animation = 'slideIn 0.6s ease forwards';
        }, 150);
        setTimeout(() => {
          explanationCard.style.animation = 'slideIn 0.6s ease forwards';
        }, 400);
        setTimeout(() => {
          signCard.style.animation = 'slideIn 0.6s ease forwards';
        }, 650);
      }
      
      function toggleMicrophone() {
        const micButton = $('#micButton');
        const isListening = micButton.classList.contains('listening');
        
        if (isListening) {
            try {
              voiceRecognizer.stop();
            } catch (e) {
              console.warn('[SignFlow] Error stopping voiceRecognizer', e);
            }
            micButton.classList.remove('listening');
            micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            $('#idiomInput').value = '';
            $('#gestureResult').textContent = '‚è∏Ô∏è Escucha detenida';
            $('#gestureResult').style.color = 'var(--slate-400)';
        } else {
            try {
              // lazy-init voiceRecognizer if missing (user opened screen without running setup)
              if (!voiceRecognizer) {
                voiceRecognizer = new VoiceRecognizer({ lang: 'en-US', interim: true });
                voiceRecognizer.onresult = ({ text, isFinal }) => {
                  $('#idiomInput').value = text;
                  if (isFinal) translateText(text);
                };
                voiceRecognizer.onerror = (err) => {
                  UI.toast(`‚ùå Error de voz: ${err}`, { type: 'error' });
                };
                voiceRecognizer.onsoundstart = () => {
                  $('#gestureResult').textContent = 'üéß Escuchando...';
                  $('#gestureResult').style.color = 'var(--blue-400)';
                };
                voiceRecognizer.onsoundend = () => {
                  $('#gestureResult').textContent = '‚úÖ Audio procesado';
                  $('#gestureResult').style.color = 'var(--green-400)';
                };
              }
              voiceRecognizer.start();
              micButton.classList.add('listening');
              micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
              $('#idiomInput').value = '';
              $('#gestureResult').textContent = 'üé§ Escuchando... Habla un modismo en ingl√©s';
              $('#gestureResult').style.color = 'var(--blue-400)';
              // Efecto visual especial
              micButton.style.boxShadow = `
                0 0 20px rgba(220, 38, 38, 0.9),
                0 0 35px rgba(220, 38, 38, 0.7)
              `;
              console.log('[SignFlow] Microphone listening started');
            } catch (err) {
              console.error('[SignFlow] Error starting microphone:', err);
              const msg = err && err.name === 'NotAllowedError' ?
                'Permiso de micr√≥fono denegado. Por favor, permite el acceso al micr√≥fono en la configuraci√≥n del navegador.' :
                err && err.message ? err.message : 'Error al iniciar el micr√≥fono';
              UI.toast(`‚ùå ${msg}`, { type: 'error', duration: 6000 });
              $('#gestureResult').textContent = msg;
              $('#gestureResult').style.color = 'var(--red-400)';
              // A√±adir bloque de ayuda con bot√≥n de reintento
              try {
                const talkContainer = $('#talkScreen');
                if (talkContainer) {
                  const existing = talkContainer.querySelector('.mic-help-detail');
                  const helpHtml = `
                    <strong>Ayuda:</strong> ${msg}
                    <div style="margin-top:8px;font-size:0.95rem;color:var(--slate-300);">
                      - Revisa los permisos del micr√≥fono en el navegador.<br>
                      - Aseg√∫rate de que no haya otra app usando el micr√≥fono.<br>
                      - Si cambias permisos, recarga la p√°gina.
                    </div>`;
                  if (existing) {
                    existing.innerHTML = helpHtml + '<div style="margin-top:8px;"><button class="retry-mic neon-button" style="padding:8px 12px; font-size:0.95rem;">üîÅ Reintentar micr√≥fono</button></div>';
                    existing.style.display = 'block';
                  } else {
                    const d = document.createElement('div');
                    d.className = 'mic-help-detail';
                    d.style.cssText = 'margin-top:12px;color:var(--slate-300);font-size:0.95rem;';
                    d.innerHTML = helpHtml + '<div style="margin-top:8px;"><button class="retry-mic neon-button" style="padding:8px 12px; font-size:0.95rem;">üîÅ Reintentar micr√≥fono</button></div>';
                    talkContainer.appendChild(d);
                  }
                  // Attach retry handler
                  const retryBtn = talkContainer.querySelector('.retry-mic');
                  if (retryBtn) {
                    retryBtn.addEventListener('click', async (ev) => {
                      ev.preventDefault();
                      console.log('[SignFlow] Retry microphone requested by user');
                      UI.toast('üîÅ Intentando reactivar el micr√≥fono...', { type: 'info', duration: 1800 });
                      $('#gestureResult').textContent = 'üîÅ Intentando reactivar micr√≥fono...';
                      $('#gestureResult').style.color = 'var(--blue-400)';
                      try {
                        const micBtn = $('#micButton');
                        if (micBtn) micBtn.click();
                      } catch (e) {
                        console.error('[SignFlow] Error triggering retry mic', e);
                      }
                    });
                  }
                }
              } catch (e) {
                console.warn('[SignFlow] Could not attach mic help detail', e);
              }
            }
        }
      }
      
      function updateLesson() {
        const lessons = [
          {
            idiom: 'Break a leg',
            spanish: '¬°Buena suerte!',
            explanation: 'Frase idiom√°tica que significa "desear suerte" antes de una actuaci√≥n. ¬°No te preocupes, no desean que te lastimes!',
            signDemo: 'ü§ö ‚Üí üçÄ ‚Üí üëç',
            exercise: 'Realiza la se√±a para "buena suerte" frente a la c√°mara',
            difficulty: 1
          },
          {
            idiom: 'Piece of cake',
            spanish: 'Pan comido',
            explanation: 'Algo que es muy f√°cil de hacer. Imagina lo f√°cil que es comer un pedazo de pastel - ¬°as√≠ de sencillo!',
            signDemo: 'üç∞ ‚Üí üëç ‚Üí ‚úÖ',
            exercise: 'Practica la se√±a para "f√°cil" o "sencillo"',
            difficulty: 1
          },
          {
            idiom: 'Cost an arm and a leg',
            spanish: 'Costar un ojo de la cara',
            explanation: 'Algo que es muy caro o costoso. Se usa para enfatizar el alto precio de un producto o servicio.',
            signDemo: 'üí™ ‚Üí üí∏ ‚Üí üò±',
            exercise: 'Completa la secuencia de se√±as para "muy caro"',
            difficulty: 2
          },
          {
            idiom: 'Butterflies in stomach',
            spanish: 'Mariposas en el est√≥mago',
            explanation: 'Sensaci√≥n de nerviosismo o ansiedad anticipatoria antes de un evento importante.',
            signDemo: 'ü¶ã ‚Üí ü§ó ‚Üí üòä',
            exercise: 'Practica la se√±a para expresar "nerviosismo"',
            difficulty: 2
          },
          {
            idiom: 'Hit the nail on the head',
            spanish: 'Dar en el clavo',
            explanation: 'Describir con exactitud o precisi√≥n algo. Se usa cuando alguien identifica el problema o la soluci√≥n de manera perfecta.',
            signDemo: 'üî® ‚Üí üéØ ‚Üí üëå',
            exercise: 'Realiza la se√±a para "precisi√≥n" o "acertado"',
            difficulty: 3
          },
          {
            idiom: 'Once in a blue moon',
            spanish: 'Muy raramente',
            explanation: 'Algo que sucede muy poco frecuentemente, casi nunca. Se refiere a eventos excepcionales o raros.',
            signDemo: 'üåô ‚Üí üîµ ‚Üí üìÖ',
            exercise: 'Practica la se√±a para "rara vez" o "ocasionalmente"',
            difficulty: 3
          },
          {
            idiom: 'Burn the midnight oil',
            spanish: 'Trabajar hasta tarde',
            explanation: 'Trabajar hasta altas horas de la noche o madrugada, generalmente para completar una tarea importante o urgente.',
            signDemo: 'üåô ‚Üí üí° ‚Üí üìö',
            exercise: 'Completa la secuencia de se√±as para "trabajar de noche"',
            difficulty: 2
          },
          {
            idiom: 'Call it a day',
            spanish: 'Dar por terminado',
            explanation: 'Decidir dejar de trabajar en algo por el resto del d√≠a, generalmente porque ya se ha trabajado lo suficiente o porque es hora de descansar.',
            signDemo: 'üì± ‚Üí ‚úã ‚Üí üò¥',
            exercise: 'Realiza la se√±a para "terminar" o "finalizar"',
            difficulty: 1
          }
        ];
        
        // Seleccionar lecciones aleatorias de la base de datos completa
        if (currentLessonIndex >= lessons.length) {
          const randomIdiom = translator.getRandomIdiom();
          lessons.push({
            idiom: randomIdiom.key,
            spanish: randomIdiom.translation,
            explanation: randomIdiom.explanation,
            signDemo: randomIdiom.signDemo,
            exercise: `Practica la se√±a para "${randomIdiom.translation}"`,
            difficulty: randomIdiom.difficulty
          });
        }
        
        const lesson = lessons[currentLessonIndex];
        $('#lessonTitle').textContent = lesson.idiom;
        $('#lessonSpanish').textContent = lesson.spanish;
        $('#lessonExplanation').textContent = lesson.explanation;
        $('#signDemo').textContent = lesson.signDemo;
        $('#exerciseText').textContent = lesson.exercise;
        $('#currentLesson').textContent = currentLessonIndex + 1;
        
        // Actualizar progreso (m√°ximo 100%)
        progress = Math.min((currentLessonIndex + 1) / lessons.length * 100, 100);
        $('#progressPercent').textContent = Math.round(progress);
        $('#progressFill').style.width = `${progress}%`;
        
        // Efecto visual al cambiar de lecci√≥n
        Animator.pulseElement($('#lessonTitle'));
      }
      
      function checkSign() {
        if (!isCameraActive) {
          UI.toast('üì∏ ¬°Activa la c√°mara primero!', { type: 'error', duration: 3200 });
          return;
        }
        
        const success = Math.random() > 0.4; // 60% chance of success
        const feedbackContainer = $('#feedbackContainerLearn');
        const nextButton = $('#nextButton');
        
        feedbackContainer.innerHTML = '';
        const feedbackCard = document.createElement('div');
        feedbackCard.style.cssText = `
          padding: 28px; border-radius: 22px; margin-top: 28px; display: flex; gap: 18px;
          background: ${success ? 'rgba(22, 163, 74, 0.2)' : 'rgba(234, 88, 12, 0.2)'};
          border: 1px solid ${success ? 'rgba(22, 163, 74, 0.5)' : 'rgba(234, 88, 12, 0.5)'};
          animation: slideIn 0.6s ease;
          backdrop-filter: blur(10px);
        `;
        
        if (success) {
          feedbackCard.innerHTML = `
                        <i class="fas fa-check-circle" style="font-size: 1.7rem; margin-top: 5px; color: #22c55e;"></i>
            <div>
              <h3 style="font-weight: 800; margin-bottom: 5px; color: white; font-size: 1.5rem;">¬°Incre√≠ble!</h3>
              <p style="color: var(--slate-200); line-height: 1.7; font-size: 1.2rem;">
                Tu se√±a fue reconocida con alta precisi√≥n por nuestra IA. 
                <strong>¬°Contin√∫a as√≠!</strong>
              </p>
            </div>
          `;
          // Update progress with animation
          progress = Math.min(progress + 12.5, 100); // 100% / 8 lecciones
          $('#progressPercent').textContent = progress;
          // Animaci√≥n de progreso
          const fill = $('#progressFill');
          fill.style.transition = 'width 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
          fill.style.width = `${progress}%`;
          // Show next button with animation
          if (currentLessonIndex < 7) {
            nextButton.style.display = 'block';
            setTimeout(() => {
              nextButton.style.opacity = '0';
              nextButton.style.transform = 'translateY(25px)';
              setTimeout(() => {
                nextButton.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                nextButton.style.opacity = '1';
                nextButton.style.transform = 'translateY(0)';
              }, 60);
            }, 120);
          }
          // Efecto de √©xito
          UI.playSuccessAnimation(feedbackCard);
          UI.toast('üéØ ¬°Se√±a correcta! +12.5% de progreso', { type: 'success' });
        } else {
          feedbackCard.innerHTML = `
            <i class="fas fa-hand-paper" style="font-size: 1.7rem; margin-top: 5px; color: #f97316;"></i>
            <div>
              <h3 style="font-weight: 800; margin-bottom: 5px; color: white; font-size: 1.5rem;">Casi lo logras</h3>
              <p style="color: var(--slate-200); line-height: 1.7; font-size: 1.2rem;">
                La IA detect√≥ tu se√±a pero con baja confianza. 
                <strong>Revisa la demostraci√≥n</strong> y vuelve a intentar.
              </p>
            </div>
          `;
          // Efecto de error
          UI.playErrorAnimation(feedbackCard);
          UI.toast('üü° Se√±a no reconocida - Ajusta tu posici√≥n', { type: 'error' });
          // Hide next button
          nextButton.style.display = 'none';
        }
        feedbackContainer.appendChild(feedbackCard);
        // Efecto de vibraci√≥n para error
        if (!success) {
          feedbackCard.style.animation = 'shake 0.6s';
          const style = document.createElement('style');
          style.textContent = `
            @keyframes shake {
              0%, 100% { transform: translateX(0); }
              10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
              20%, 40%, 60%, 80% { transform: translateX(6px); }
            }
          `;
          document.head.appendChild(style);
        }
      }
      function nextLesson() {
        if (currentLessonIndex < 7) {
          currentLessonIndex++;
          updateLesson();
          // Reset feedback
          $('#feedbackContainerLearn').innerHTML = '';
          $('#nextButton').style.display = 'none';
          $('#recordFeedback').textContent = '';
          // Efecto de transici√≥n
          const lessonCard = $('.lesson-card');
          lessonCard.style.opacity = '0';
          lessonCard.style.transform = 'translateY(25px)';
          setTimeout(() => {
            lessonCard.style.transition = 'all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            lessonCard.style.opacity = '1';
            lessonCard.style.transform = 'translateY(0)';
          }, 60);
          UI.toast(`‚û°Ô∏è Avanzando a: "${$('#lessonTitle').textContent}"`, {
            type: 'info',
            duration: 2800
          });
        } else {
          UI.toast('üéâ ¬°Felicidades! Has completado todas las lecciones.', {
            type: 'success',
            duration: 4500
          });
          // Reset progress after completion
          setTimeout(() => {
            currentLessonIndex = 0;
            progress = 0;
            updateLesson();
            $('#nextButton').style.display = 'none';
            $('#feedbackContainerLearn').innerHTML = '';
            $('#recordFeedback').textContent = '';
          }, 5000);
        }
      }
      function switchTab(tab) {
        // Update tab buttons
        $$('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        // Show/hide content
        if (tab === 'translate') {
          $('#translateContent').style.display = 'block';
          $('#practiceContent').classList.add('hidden');
          // Detener c√°mara si est√° activa
          if (isCameraActive) {
            gestureRecognizer.stopCamera();
            isCameraActive = false;
            $('#startCamera').disabled = false;
            $('#startCamera').innerHTML = 'Iniciar C√°mara';
            $('#stopCamera').disabled = true;
          }
        } else {
          $('#translateContent').style.display = 'none';
          $('#practiceContent').classList.remove('hidden');
          // Mensaje inicial para la c√°mara
          $('#gestureResult').textContent = 'üñêÔ∏è Posiciona tus manos frente a la c√°mara para practicar se√±as';
          $('#gestureResult').style.color = 'var(--slate-300)';
        }
      }
      /* -----------------------
         Boot & navigation handling mejorado
      ----------------------- */
      document.addEventListener('DOMContentLoaded', async () => {
        // Crear part√≠culas flotantes
        createFloatingParticles();
        // Hide main screen initially
        $('#mainScreen').classList.add('hidden');
        // Setup navigation global
        window.navigateTo = (sectionId) => {
          if (sectionId === 'splash') {
            // Reiniciar splash screen
            $('#splashScreen').classList.remove('hidden');
            document.querySelector('.splash-title').classList.remove('visible');
            document.querySelector('.splash-subtitle').classList.remove('visible');
            document.querySelector('.loader').classList.remove('visible');
            // Reiniciar animaciones
            setTimeout(() => {
              document.querySelector('.splash-title').classList.add('visible');
            }, 250);
            setTimeout(() => {
              document.querySelector('.splash-subtitle').classList.add('visible');
            }, 950);
            setTimeout(() => {
              document.querySelector('.loader').classList.add('visible');
            }, 1700);
            // Navegar a main despu√©s de 3 segundos
            setTimeout(() => {
              navigateTo('main');
            }, 3200);
            navigator.current = 'splashScreen';
            return;
          }
          // Setup section content when needed BEFORE showing it
          if (sectionId === 'talk' && !$('#talkScreen').dataset.ready) {
            setupTalkExplain();
          }
          if (sectionId === 'learn' && !$('#learnScreen').dataset.ready) {
            setupLearnPractice();
          }
          // Now show the section (after setup so listeners/elements are ready)
          navigator.show(sectionId);
          // Reset states
          if (sectionId === 'main') {
            currentLessonIndex = 0;
            progress = 0;
            if ($('#learnScreen').dataset.ready) {
              updateLesson();
              $('#nextButton').style.display = 'none';
              $('#feedbackContainerLearn').innerHTML = '';
              $('#recordFeedback').textContent = '';
            }
          }
        };
        // Animaci√≥n inicial mejorada
        setTimeout(() => {
          document.querySelector('.splash-title').classList.add('visible');
        }, 250);
        setTimeout(() => {
          document.querySelector('.splash-subtitle').classList.add('visible');
          // Efecto de brillo especial
          const title = document.querySelector('.splash-title');
          title.style.textShadow = '0 0 30px rgba(255, 255, 255, 0.9), 0 0 60px rgba(96, 165, 250, 0.7)';
        }, 950);
        setTimeout(() => {
          document.querySelector('.loader').classList.add('visible');
        }, 1700);
        // Auto-navigate to main after splash screen
        setTimeout(() => {
          navigateTo('main');
        }, 3200);
        // Inicializar efectos ne√≥n
        setupNeonEffects();
        // Wrap any plain-text occurrences of the word 'flow' (case-insensitive) with a span.flow to force yellow color
        (function wrapFlowWords() {
          const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
            acceptNode(node) {
              if (!node.parentNode) return NodeFilter.FILTER_REJECT;
              const parentTag = node.parentNode.nodeName.toLowerCase();
              if (['script','style','noscript','code','pre','textarea'].includes(parentTag)) return NodeFilter.FILTER_REJECT;
              if (!/\bflow\b/i.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          });

          const toWrap = [];
          while (walker.nextNode()) toWrap.push(walker.currentNode);
          toWrap.forEach(textNode => {
            const frag = document.createDocumentFragment();
            const parts = textNode.nodeValue.split(/(\bflow\b)/i);
            parts.forEach(part => {
              if (/^flow$/i.test(part)) {
                const span = document.createElement('span');
                span.className = 'flow';
                span.textContent = part;
                frag.appendChild(span);
              } else {
                frag.appendChild(document.createTextNode(part));
              }
            });
            textNode.parentNode.replaceChild(frag, textNode);
          });
        })();
        // A√±adir evento de teclado para navegaci√≥n
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (navigator.current !== 'mainScreen') {
              navigateTo('main');
            }
          }
        });
      });
      // Export API for debugging
      window.SignFlow = {
        translator,
        navigateTo,
        voiceRecognizer,
        gestureRecognizer,
        practiceManager
      };
    })();
  </script>
</body>
</html>
